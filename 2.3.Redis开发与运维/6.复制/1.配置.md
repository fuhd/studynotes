配置
===============================================================
在分布式系统中为了 **解决单点问题，通常会把数据复制多个副本部署到其他机器**，满足故障恢复和负载无均衡等需求。
Redis也是如此，它为我们提供了复制功能，实现了相同数据的多个Redis副本。**复制功能是高可用Redis的基础**，
后面章节的 **哨兵** 和 **集群** 都是 **在复制的基础上实现高可用的**。

### 配置

#### 建立复制
参与复制的Redis实例划分为 **主节点（master）** 和 **从节点（slave）。默认情况下，Redis都是主节点。
每个从节点只能有一个主节点，而主节点可以同时具有多个从节点。复制的数据流是单向的，只能由主节点复制到从节点**。

配置复制的方式有以下三种：
+ **在配置文件中加入`slaveof {masterHost} {masterPort}` 随Redis启动生效**。
+ **在`redis-server`启动命令后加入 `--slaveof {masterHost} {masterPort}`**。
+ **直接使用命令：`slaveof {masterHost} {masterPort}` 生效**。

综上所述，`slaveof`命令在使用时，可以运行期动态配置，也可以提前写到配置文件中。例如本地启动两个端口为
`6379`和`6380`的Redis节点，在`127.0.0.1:6380`执行如下命令：
```shell
127,0.0.1:6380>slaveof 127.0.0.1 6379
```
`slaveof`配置都是在从节点发起，这时`6379`作为主节点，`6380`作为从节点。复制关系建立后执行如下命令测试：
```shell
127.0.0.1:6379> set hello redis
OK
127.0.0.1:6379> get hello
"redis"
127.0.0.1:6380> get hello
"redis"
```
上例中，针对主节点`6379`的任何修改都可以同步到从节点6380中。

**`slaveof`本身是异步命令，执行`slaveof`命令时，节点只保存主节点信息后返回，后续复制流程在节点内部异步执行**。
主从节点复制成功建立后，可以 **使用`info replication`命令查看复制相关状态**。

1. 主节点6379复制状态信息：
```shell
127.0.0.1:6379> info replication
# replication
role:master
commected_slaves:1
slave0:ip=127.0.0.1,port=6379,state=online,offset=43,lag=0
```

2. 从节点6380复制状态信息：
```shell
127.0.0.1:6380> info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:8380
master_link_status:up
master_last_io_seconds_ago:4
master_sync_in_progress:0
......
```

#### 断开复制
slaveof命令不但可以建立复制，还可以 **在从节点执行`slaveof no one`来断开与主节点复制关系**。

**断开复制主要流程**：
1. 断开与主节点复制关系。
2. 从节点晋升为主节点。

**从节点断开复制后并不会抛弃原有数据，只是无法再获取主节点上的数据变化**。

通过`slaveof`命令还可以实现 **切主操作**，**所谓切主是指把当前从节点对主节点的复制切换到另一个主节点。
执行`slaveof {newMasterIP} {newMasterPort}`命令即可**，例如把6380节点从原来的复制6379节点
变为复制6381节点。

**切主操作流程如下**：
1. 断开与旧主节点复制关系
2. 与新主节点建立复制关系
3. **删除从节点当前所有数据**
4. 对新主节点进行复制操作

**注意：切主后从节点会清空之前所有的数据**。

#### 安全性
对于数据比较重要的节点，主节点会通过设置 **`requirepass`** 参数进行 **密码验证**，这时所有的客户端访问必须使用
**`auth`** 命令实行校验。从节点与主节点的复制连接是通过一个特殊标识的客户端来完成，因此需要配置从节点的 **`masterauth`**
参数与主节点密码保持一致，这样从节点才可以正确地连接到主节点并发起复制流程。

#### 只读
**默认情况下**，从节点使用 **`slave-read-only=yes`** 配置为 **只读模式**。由于 **复制只能从主节点到从节点，对于从节点的任何
修改主节点都无法感知**，修改从节点会造成主从数据不一致。**因此建议线上不要修改从节点的只读模式**。

#### 传输延迟
主从节点一般部署在不同机器上，**复制时的网络延迟就成为需要考虑的问题**，Redis为我们提供了 **`repl-disable-tcp-nodelay`**
参数用于控制 **是否关闭`TCP_NODELAY`，默认关闭**，说明如下：
+ **当关闭时，主节点产生的命令数据无论大小都会及时地发送给从节点，这样主从之间延迟会变小，但增加了网络带宽的消耗**。
适用于主从之间的网络环境良好的场景，如同机架或同机房部署。
+ **当开启时，主节点会合并较小的TCP数据包从而节省带宽**。默认发送时间间隔取决于Linux的内核，**一般为40毫秒**。
这种配置节省了带宽但增大主从之间的延迟。适用于主从网络环境复杂或带宽紧张的场景，如跨杋房部署。

**注意**：部署主从节点时需要考虑网络延迟、带宽使用率、防灾级别等因素，**如要求低延迟时，建议同机架或同机房部署
并关闭`repl-disable-tcp-nodelay`；如果考虑高容灾性，可以同城跨机房部署并开启`repl-disable-tcp-nodelay`**。
