认证(Authentication)与源码解读
===============================================================================
在`Spring Security`中，认证过程称之为 **`Authentication`(验证)**，指的是建立系统使用者信息(`principal`)的过程。
使用者可以是一个 **用户、设备、或者其他可以在我们的应用中执行某种操作的其他系统**。

到目前为止，我们只是在`SecurityConfig`类中进行了最基础的认证配置。现在我们来看一些更加高级的认证配置。

### 基于内存的验证
我们已经看过一个在内存中配置单个用户验证的配置，以下的代码可以配置多个用户：
```java
@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    auth.inMemoryAuthentication()
        .withUser("user").password("password").roles("USER")
        .and()
        .withUser("admin").password("password").roles("USER", "ADMIN");
}
```

### JDBC验证
接下来你将看到对于基于`JDBC`验证的支持。以下案例假设你已经在你的应用中定义一个`DataSource`：
```java
@Autowired
private DataSource dataSource;

@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    auth.jdbcAuthentication()
        .dataSource(dataSource)
        .withDefaultSchema()
        .withUser("user").password("password").roles("USER")
        .and()
        .withUser("admin").password("password").roles("USER", "ADMIN");
}
```

### AuthenticationProvider
我们可以自定义一个`AuthenticationProvider`，并使其作为`Spring`的`Bean`。例如以下代码是假设有一个自定义的类
`SpringAuthenticationProvider`，其实现了`AuthenticationProvider`的配置。
```java
@Bean
public SpringAuthenticationProvider springAuthenticationProvider() {
    return new SpringAuthenticationProvider();
}
```

#### UserDetailsService
我们还可以自定义一个`UserDetailsService`，来实现验证。以下代码假设`SpringDataUserDetailsService`实现了
`UserDetailsService`。
```java
@Bean
public SpringDataUserDetailsService springDataUserDetailsService() {
    return new SpringDataUserDetailsService();
}
```
我们同样还可以配置`PasswordEncoder`，来指定密码的编码方式：
```java
@Bean
public BCryptPasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```
完整示例：
```java
@Bean
public UserDetailsService userDetailsService() {
    return new CustomUserDetailsService();
}

@Bean
public PasswordEncoder passwordEncoder(){
    return new Md5PasswordEncoder();
}

@Bean
public AuthenticationProvider authenticationProvider(){
    DaoAuthenticationProvider authenticationProvider = new DaoAuthenticationProvider();
    authenticationProvider.setUserDetailsService(userDetailsService());
    authenticationProvider.setPasswordEncoder(passwordEncoder());
    return authenticationProvider;
}

public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    //auth.userDetailsService(userDetailsService());
    auth.authenticationProvider(authenticationProvider());
}
```

### 源码解读
首先不管是哪一种验证方式(内存、`JDBC`还是`LDAP`)，我们都是通过一个自动注入的`AuthenticationManagerBuilder`对象来完成的。

从名字中就可以看出，这个类是用于构建`AuthenticationManager`。**那么`AuthenticationManager`是什么呢**？
其作用是 **对用户提交的用户名和密码进行验证**。


