证书管理之KeyTool证书管理
===============================================================
任何机构或个人都可以申请数字证书，并使用由`CA`机构颁发的数字证书为自己的应用帮保驾护航。

要获得数字证书，我们需要使用数字证书管理工具（如 **`KeyTool`** 和 **`OpenSSL`** ）构建CSR
（`Certificate Signing Request`，数字证书签发申请），交由CA机构签发，形成最终的数字证书。

**`KeyTool`是Java中的数字证书管理工具，用于数字证书的申请、导入、导出和撤销等操作**。
`KeyTool`与本地密钥库相关联，**将私钥存于密钥库，公钥则以数字证书输出**。`KeyTool`位于`%JAVA_HOME%\bin`目录中，
需要通过命令行进行相应的操作。

### 构建自签名证书
申请数字证书之前，需要在密钥库中以 **别名** 的方式生成本地数字证书，建立相应的 **加密算法、密钥、有效期等信息**，
同时需要提供 **用户身份信息**，我们可以为自己签发一个数字证书（即自签名证书）。

这里我们使用“`www.zlex.org`”作为别名，使用`RSA`作为加密算法，并规定密钥长度为`2048`位，使用`SHA1withRSA`
作为数字签名算法，欲签发有效期为`36000`天的数字证书。完整命令如下：
```shell
$ keytool -genkeypair -keyalg RSA -keysize 2048 -sigalg SHA1withRSA -validity 36000
    -alias www.zlex.org -keystore zlex.keystore
```
各参数的含义如下：

| 参数 | 描述 |
|:-----|:-----|
| **-genkeypair** | **表示生成密钥** |
| **-keyalg** | **指定密钥算法，这里指定为`RSA`算法** |
| **-keysize** | **指定密钥长度，默认1024位，这里指定为2048位** |
| **-sigalg** | **指定数字签名算法，这里指定为`SHA1withRSA`算法** |
| **-validity** | **指定证书有效期，这里指定为`36000`天** |
| **-alias** | **指定别名，这里是`www.zlex.org`** |
| **-keystore** | **指定密钥库存储位置，这里是`zlex.keystore`** |

**`KeyTool`工具支持`RSA`和`DSA`共2种算法，且`DSA`算法为默认算法**。

执行上述命令后，可按相应的提示输入用户的相关信息，如：
```
输入keystore密码：******
再次输入新密码：******
您的名字与姓氏是什么？
[Unknown]: www.zlex.org
您的组织单位名称是什么？
[Unknown]: zlex
您的组织名称是什么？
[Unknown]: zlex
您所在的城市或区域名称是什么？
[Unknown]: BJ
您所在的州或省份名称是什么？
[Unknown]: BJ
该单位的两字母国家代码是什么
[Unknown]: CN
CN=www.zlex.org, OU=zlex, O＝zlex, L=BJ, ST=BJ,C=CN 正确吗？
[否]：Y
输入<www.zlex.org>的主密码（如果和keystore密码相同，按回车）：
```
这里我们输入密码：“`123456`”，也可通过参数 “**`-storepass`**” 指定密码“`123456`”。
以 "www.zlex.org" 作为用户的姓名。这里的用户并不是指代现实意义中的用户个体，而是指代网络环境中
的用户个体。因此，通常使用域名或带有通配符“`*`”的泛域名，如“`*.zlex.org`”标识用户身份。

我们可以使用参数 **`-dname`** 指定用户信息，代替上述手动输入用户信息。完整命令如下：
```shell
$ keytool -genkeypair -keyslg RSA -keysize 2048 -sigalg SHA1withRSA -validity 3600
    -alias www.zlex.org -keystore zlex.keystore -dname "CN=www.zlex.org, OU=zlex, 
    O=zlex, L=BJ, ST=BJ, C=CN"
```
经过上述操作后，密钥库中已经创建了数字证书。**虽然这时的数字证书并没有经过`CA`认证，
但并不影响我们使用。我们仍可以将数字证书导出，发送给合作伙伴进行加密交互**。完整命令如下：
```shell
# 导出数字证书
$ keytool -exportcert -alias www.zlex.org -keystore zlex.keystore -file zlex.cer -rfc
```
各参数的含义如下所示：

| 参数 | 描述 |
|:-----|:-----|
| **-exportcert** | **表示证书导出操作** |
| **-alias** | **指定导别名，这里为www.zlex.org** |
| **-keystore** | **指定密钥库文件，这里为zlex.keystore** |
| **-file** | **指定导出文件路径，这里为zlex.cer** |
| **-rfc** | **指定以Base64编码格式输出** |

这里我们输入密码“123456”，也可通过参数“ **`-storepass`**”指定密码“123456”，将获得数字证书文件“zlex.cer”。

我们可以通过相应的命令在控制台打印数字证书的信息，命令如下：
```shell
# 打印数字证书
$ keytool -printcert -file zlex.cer
```
控制台打印数字证书信息如下：
```
所有者: CN=www.zlex.org, OU=zlex, O=zlex, L=BJ, ST=BJ, C=CN
发布者: CN=www.zlex.org, OU=zlex, O=zlex, L=BJ, ST=BJ, C=CN
序列号: 67fd9820
有效期开始日期: Wed Sep 13 19:22:15 CST 2017, 截止日期: Tue Apr 07 19:22:15 CST 2116
证书指纹:
	 MD5: 52:A9:7D:A6:85:1B:B6:F9:EE:3C:48:F4:04:ED:95:EC
	 SHA1: 28:16:18:F8:69:15:1F:F9:11:66:58:6E:D5:88:BD:5F:BE:01:0E:8D
	 SHA256: 64:C0:3D:41:B9:C1:28:98:94:BE:24:24:2C:8D:A0:BD:15:77:D7:94:A3:1E:22:8F:33:F9:59:D8:B3:E7:B2:69
	 签名算法名称: SHA1withRSA
	 版本: 3

扩展: 

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 7D CE 92 83 BE 8F 3C EB   E1 44 30 9D 2A 00 57 95  ......<..D0.*.W.
0010: E2 7D C5 E1                                        ....
]
]
```
这里通过`keytool`工具直接导出的证书，是一个自签名的 **`X.509`第三版类型的根证书**，并以 **`Base64`编码** 保存。
自签名证书虽然可以使用，**但未经过`CA`机构认证，几乎没有任何法律效力**。在使用自签名证书时，我们需要将其导入系统。

### 构建CA签发证书
如果要获取 **`CA`机构** 认证的数字证书，需要将 **数字证书签发申请（`CSR`）** 导出，经由`CA`机构认证并颁发，
同时将认证后的证书导入 **本地密钥库和信任库**。

导出数字证书签发申请操作如下：
```shell
# 导出数字证书签发申请
$ keytool -certreq -alias www.zlex.org -keystore zlex.keystore -file zlex.csr -v
```
各参数的含义如下所示：

| 参数 | 描述 |
|:-----|:-----|
| **-certreq** | **表示数字证书申请操作** |
| **-alias** | **指定别名，这里为www.zlex.org** |
| **-keystore** | **指定密钥库文件，这里为zlex.keystore** |
| **-file** | **指定导出文件路径，这里为zlex.csr** |
| **-v** | **详细信息** |

这里我们输入密码“123456”，也可通过参数“ **`-storepass`**”指定密码“123456”。执行上述命令后，将得到一个 **PKCS#10
编码格式** 的数字证书签发申请文件，即文件“zlex.csr”。

目前，由`VeriSign`(`http://www.verisign.com`)、`GeoTrust`(`http://www.geotrust.com/`) 和`Thawte`
(`http://www.thawte.com/`) 国际权威数字证书颁发认证机构“三巨头”签发的数字证书价格不菲，**但这三大认证机构几乎都
提供了用于测试的数字证书**，读者朋友可以提交`CSR`文件内容，获得相应的签发数字证书。**这些用于测试的数字证书通常在时效上
扩展功能等方面有限制**。当然，我们可以使用免费的国际权威数字证书颁发认证机构签发数字证书，如`CAcert`(`http://www.cacert.org/`)。

获得签发后的数字证书后，**需要将其导入信任库**。导入数字证书操作如下：
```shell
# 导入数字证书
$ keytool -importcert -trustcacerts -alias www.zlex.org -file zlex.cer -keystore zlex.keystore
```
各参数的含义如下所示：

| 参数 | 描述 |
|:----|:-----|
| **-importcert** | **表示导入数字证书** |
| **-trustcacerts** | **表示将数字证书导入信任库** |
| **-alias** | **指定导别名，这里为www.zlex.org** |
| **-file** | **指定导入数字证书文件路径，这里为zlex.cer** |
| **-keystore** | **指定密钥库文件，这里为zlex.keystore** |

这里我们输入密码“123456”，也可通过参数“ **-storepass** ”指定密码“123456”，并输入“Y”确认导入该证书。

导入证书后，我们可以 **通过相关命令查看该证书**，命令如下：
```shell
# 查看导入数字证书
$ keytool -list -alias www.zlex.org -keystore zlex.keystore
```
各参数的含义如下所示：

| 参数 | 描述 |
|:-----|:-----|
| **-list** | **查看数字证书** |
| **-alias** | **指定别名，这里为www.zlex.org** |
| **-keystore** | **指定密钥库文件，这里为zlex.keystore**|

这里我们输入密码“123456”，也可通过参数“ **`-storepass`**”指定密码“123456”。**我们也可以加入参数“`-v`”或“`-rfc`”
查看该证书的详细信息**。

完成上述操作后，我们需要使用证书导出命令导出数字证书，并将其发放给合作伙伴使用。















