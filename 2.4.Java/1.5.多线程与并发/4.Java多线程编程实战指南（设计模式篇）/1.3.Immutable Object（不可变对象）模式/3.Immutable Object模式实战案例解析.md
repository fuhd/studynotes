Immutable Object模式实战案例解析
================================================================================
某彩信网关系统在处理由增值业务提供商（`VASP`，`Value-Added Service Provider`）下发给手机终端用户的彩信消息时，
需要根据彩信接收方号码的前缀（如：`1381234`）选择对应的彩信中心（`MMSC`，`Multimedia Messaging Service Center`），
然后转发消息给选中的彩信中心，由其负责对接电信网络将彩信消息下发给手机终端用户。彩信中心相对于彩信网关系统而言，
它是一个独立的部件，二者通过网络进行交互。**这个选择彩信中心的过程，我们称之为路由（`Routing`）。而手机号前缀和彩信中心的
这种对应关系，被称为路由表。路由表在软件运维过程中可能发生变化**。例如，业务扩容带来的新增彩信中心，为某个号码前缀指定新的
彩信中心等。**虽然路由表在该系统中是由多线程共享的数据，但是这些数据的变化频率并不高。因此，即使是为了保证线程安全，
我们也不希望对这些数据的访问进行加锁等并发访问控制，以免产生不必要的开销和问题。这时，`Immutable Object`模式就派上用场了**。

**维护路由表可以被建模为一个不可变对象**，如下示例：
```java
//使用不可变对象维护路由表
/*
 * 彩信中心路由规则管理器
 * 模式角色：ImmutableObject
 */
 public final class MMSCRouter {
     //用volatile修饰，保证多线程环境下该变量的可见性
     private static volatile MMSCRouter instance = new MMSCRouter();
     //维护手机号码前缀到彩信中心之间的映射关系
     private final Map<String,MMSCInfo> routeMap;
     public MMSCRouter() {
         //将数据库表中的数据加载到内存，存为Map
         this.routeMap = MMSCRouter.retrieveRouteMapFromDB();
     }
     private static Map<String, MMSCInfo> retrieveRouteMapFromDB() {
         Map<String, MMSCInfo> map = new HashMap<String, MMSCInfo>();
         //省略其他代码
         return map;
     }
     public static MMSCRouter getInstance() {
         return instance;
     }
     /**
      * 根据手机号码前缀获取对应的彩信中心信息
      */
      public MMSCInfo getMMSC(String msisdnPrefix) {
          return routeMap.get(msisdnPrefix);
      }
      /**
       * 将当前MMSCRouter的实例更新为指定的新实例
       */
       public static void setInstance(MMSCRouter newInstance) {
           instance = newInstance;
       }
       private static Map<String,MMSCInfo> deepCopy(Map<String, MMSCInfo> m) {
           Map<String, MMSCInfo> result = new HashMap<String, MMSCInfo>();
           for (String key: m.keySet()) {
               result.put(key, new MMSCInfo(m.get(key)));
           }
           return result;
       }
       public Map<String, MMSCInfo> getRouteMap() {
           //做防御性复制
           return Collections.unmodifiableMap(deepCopy(routeMap));
       }
 }
```
**而彩信中心的相关数据，如彩信中心设备编号、URL、支持的最大附件尺寸也被建模为一个不可变对象**，如下代码：
```java
//使用不可变对象表示彩信中心信息
```