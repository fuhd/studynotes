自给自足的脚本：位于第一行的#!
===================================================================================
**当Shell执行一个程序时，会要求UNIX内核启动一个新的进程（process），以便在该进程里执行所指定的程序**。
内核知道如何为编译型程序做这件事。我们的nusers Shell脚本 **并非编译型程序**，当Shell要求内核执行它时，
内核将无法做这件事，**并回应“not executable format file”（不是可执行的格式文件）错误信息**。Shell
收到此错误信息时，就会说“啊哈，这不是编译型程序，那么一定是Shell脚本”，接着 **会启动一个新的`/bin/sh`
（标准Shell）副本来执行该程序**。

**现行的UNIX系统都会拥有好几个Shell，因此需要通过一种方式，告知UNIX内核应该以哪个Shell来执行所指
定的Shell脚本**。事实上，这么做有助于 **执行机制的通用化** ，让用户得以 **直接引用任何的程序语言解释
器，而非只是一个命令Shell**。方法是，**通过脚本文件中特殊的第一行来设置，在第一行的开头处使用`#!`这
两个字符**。

当一个文件中开头的两个字符是 **`#!`** 时，**内核会扫描该行其余的部分，看是否存在可用来执行程序的解释
器的完整路径**。（中间如果出现任何空白符号都会略过。）此外，**内核还会扫描是否有一个选项要传递给解
释器。内核会以被指定的选项来引用解释器，再搭配命令行的其他部分**。举例来说，假设有一个csh脚本，名为
`/usr/ucb/whizprog`，它的第一行如下所示：
```shell
#! /bin/csh -f
```
```
注明：

/bin/csh是C Shell的命令解释器，由加州大学伯克利分校所开发。本书不讨论C Shell程序设计的原因很多，其中最重要的一点是：
就脚本的编写来说，大多数人认为它不是个好用的Shell，另一个原因则是它并未被POSIX标准化。
```
再者，如果Shell的查找路径（后面会介绍）里有`/usr/ucb`，当用户键入`whizprog -q /dev/tty01` 这条命令，
内核解释 `#!` 这行后，便会以如下的方式来引用csh：
```shell
/bin/csh -f /usr/ucb/whizprog -q /dev/tty01
```
**这样的机制让我们得以轻松地引用任何的解释器**，例如我们可以这样引用独立的 **awk程序**：
```shell
#! /bin/awk -f
此处是awk程序
```
**Shell脚本通常一开始都是`#! /bin/sh`**。如果你的`/bin/sh`并不符合POSIX标准。请将这个路径改为符合
POSIX标准的Shell。下面是 **几个初级的陷阱**，请特别留意：
+ 当今的系统，**对`#!`这一行的长度限制从63到1024个字符都有**。请尽量不要超过 **64** 个字符。
+ 在某些系统上，命令行部分（也就是要传递给解释器执行的命令）包含了命令的完整路径名称。不过有些系统
却不是这样；命令行的部分会原封不动地传给程序。因此，**脚本是否具可移植性取决于是否有完整的路径名称**。
+ **别在选项之后放置任何空白，因为空白也会跟着选项一起传递给被引用的程序**。
+ **你需要知道解释器的完整路径名称。这可以用来规避可移植性问题**，因为不同的厂商可能将同样的东西放
在不同的地方（例如`/bin/awk`和`/usr/bin/awk`）。
+ **一些较旧的系统上，内核不具备解释 `#!` 的能力**，有些Shell会自行处理，这些Shell对于 `#! `与紧随其
后的解释器名称之间是否可以有空白，可能有不同的解释。

下表列出了 **各UNIX系统对于` #! `行的长度限制**。结果出乎意料：**有一半以上的数字都不是2的次方**。

| 平台 | 操作系统版本 | 最大长度 |
| :------------- | :------------- | :-------------- |
| Apple Power Mac | Mac Darwin 7.2(Mac OS 10.3.2) | 512 |
| Compaq/DEC Alpha | OSF/1 4.0 | 1024 |
| Compaq/DEC/HP Alpha | OSF/1 5.1 | 1000 |
| GNU/Linux | Red Hat 6,7,8,9; Fedora 1 | 127 |
| HP PA-RISC and Itanium-2 | HP-UX 10, 11 | 127 |
| IBM RS/6000 | AIX 4.2 | 255 |
| Intel x86 | FreeBSD 4.4 | 64 |
| Intel x86 | FreeBSD 4.9,5.0,5.1 | 128 |
| Intel x86 | NetBSD 1.6 | 63 |
| Intel x86 | OpenBSD 3.2 | 63 |
| SGI MIPS | IRIX 6.5 | 255 |
| Sun SPARC, x86 | Solaris 7,8,9,10 | 1023 |

**POSIX标准对 `#!` 的行为模式保留未定义（unspecified）状态**。此状态是“**只要一直保持POSIX兼容性，
这是一个扩展功能**”的标准说法。

本书接下来的所有脚本开头都会有`#!`行。下面是修订过的nusers程序：
```shell
$ cat nusers                #显示文件内容
#! /bin/sh -                #神奇的#!行

who | wc -l                 #所要执行的命令
```
**选项`-`表示没有Shell选项，这是基于安全上的考虑，可避免某种程序的欺骗式攻击（spoofing attack）**。
