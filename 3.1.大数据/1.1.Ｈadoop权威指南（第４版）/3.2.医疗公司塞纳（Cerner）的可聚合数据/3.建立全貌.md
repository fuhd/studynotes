建立全貌
=========================================================================
规模化的理解和管理健康医疗需要 **大量干净、规范化和可靠的数据**。不幸的是，这样的数据通常 **分布在许多数据源** 中，
合并起来较为困难且易于出错。医院、医生办公室、诊所和药房各自拥有个人记录的一部分，以行业标准的格式，
诸如`CCDs（Continuity of Care Documents）`、`HL7`（`Health Level 7`，一种健康医疗数据交换格式），
`CSV`文件或专有格式存储。

我们面临的挑战是，**如何获取这一数据，将其转换为一种干净、集成的表现形式**，并使用它创建注册信息，以帮助患者
管理明确的病情、度量健康医疗的可操作方面，并支持各种分析。

一个至关重要的步骤是，**创建一个我们可以依赖的干净的、语义集成的基础**，这也是本章实例学习的聚焦点。**我们先将数据
规范化为一种通用结构**。这一系统的早期版本使用了不同的模型，**但是后来都已经迁移至`Avro`以便在各处理步骤之间存储和共享
数据**。

下面的示例给出了一个简化的 **`Avro IDL`** 以描述我们提出的通用结构：
```java
@namespace("com.cerner.example")
protocol PersonProtocol {
    record Demographics {
        string firstName;
        string lastName;
        string dob;
        ...
    }
    record LabResult {
        string personId;
        string labDate;
        int labId;
        int labTypeId;
        int value;
    }
    record Medication {
        string personId;
        string medicationId;
        string dose;
        string doseUnits;
        string frequency;
        ...
    }
    record Diagnosis {
        string personId;
        string diagnosisId;
        string date;
        ...
    }
    record Allergy {
        string persionId;
        int allergyId;
        int substanceId;
        ...
    }
    /**
     * Represents a person's record from a single source.
     */
    record PersonRecord {
        string personId;
        Demographics demographics;
        array<LabResult> labResults;
        array<Allergy> allergies;
        array<Medication> medications;
        array<Diagnosis> diagnoses;
        ...
    }
}
```
注意，**这里多种数据类型都嵌套在一条通用个人记录中，而不是分散在不同数据集中**。这种结构支持对这类数据的
**最常见的使用模式**（查看一条完整的记录）**无需对数据集进行大量昂贵的连接操作**。

将数据写入`PCollection<PersonRecord>`使用了 **一系列`Crunch`管线**，这样可以 **隐藏每个源的复杂性**，
并提供了一个 **与原始规范化记录数据进行交互的简单接口**。在幕后，每个`PersonRecord`可以存储在 **`HDFS`** 中或者
**作为`HBase`的一行存储**，其中每个人的数据元素分布在 **列簇（`column families`）** 和 
**列描述（`column qualifiers`）** 中。聚合的结果看起来如下表：

聚合数据：

| 源 | 个人ID | 个人统计信息 | 数据 |
|:---|:------|:-----------|:-----|
| 医生办公室 | 12345 | Abraham Lincoln... | 糖尿病诊断，实验室结果 |
| 医院 | 98765 | Abe Lincoln... | 流感诊断 |
| 药房 | 98765 | Abe Lincoln... | 过敏、药物 |
| 诊断 | 76543 | A.Lincoln... | 实验室结果 |

希望从一些获得授权的源中检索数据的用户调用一个“ **`retriever API`**”，就可以轻松地为被请求数据生成一个
**`Crunch PCollection`**：
```java
Set<String> sources = ...;
PCollection<PersonRecord> personRecords = RecordRetriever.getData(pipeline, sources);
```
这种 **`retriever`模式允许用户载入数据集，而无需知道这些数据集物理上是如何及在哪里存储的**。在本书编写的同时，
这一模式的某些用途正被新兴的 **`Kite SDK(http://kitesdk.org/)`** 所取代，**用于在`Hadoop`中管理数据**。
**检索到的`PCollection<PersonRecord>`中的每个条目代表了一个人在单一源中的完整医疗记录**。






