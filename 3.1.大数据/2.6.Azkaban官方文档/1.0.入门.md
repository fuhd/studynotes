入门
================================================================================
在`3.0`版之后，我们提供两种模式：独立“Solo服务”模式和分布式多执行器模式。以下描述了两种模式之
间的差异。

**在Solo服务模式下，数据库嵌入H2**，并且Web服务器和执行程序服务器都在同一进程中运行。如果只是
想尝试一下，这应该是有用的。它也可以用于小规模的用例。

**多执行器模式适用于最严肃的生产环境。它的DB应该由具有主从设置的MySQL实例支持。理想情况下，Web
服务器和执行程序服务器应在不同的主机中运行，以便升级和维护不应影响用户**。这种多主机设置为Azkaban
带来了强大且可扩展的方面。

+ 设置数据库
+ 配置数据库以使用多个执行程序
+ 为在数据库中配置的每个执行程序下载并安装Executor Server
+ 安装Azkaban插件
+ 安装Web服务器

以下是如何设置Azkaban的说明。

## 1.从源构建
Azkaban构建使用Gradle（使用gradlew运行时自动下载，这是Gradle包装器）并且需要 **Java8或更高
版本**。

以下命令在`Linux`，`OS X`等`* nix`平台上运行。
```shell
# Build Azkaban
./gradlew build

# Clean the build
./gradlew clean

# Build and install distributions
./gradlew installDist

# Run tests
./gradlew test

# Build without running tests
./gradlew build -x test
```
Gradle在项目目录中创建`.tar.gz`文件。例如：
`./azkaban-solo-server/build/distributions/azkaban-solo-server-0.1.0-SNAPSHOT.tar.gz`。
使用`tar -xvzf path/to/azkaban-*.tar.gz`解压缩。

## 2.Solo Server入门
Solo服务是Azkaban的独立实例，也是最简单的入门实例。Solo服务具有以下优点。
+ **易于安装** - 无需MySQL实例。它将H2打包为主要的持久存储。
+ **易于启动** - Web服务器和执行程序服务器都在同一个进程中运行。
+ **全功能** - 它包含所有Azkaban功能。您可以以正常方式使用它并为其安装插件。

### 2.1.安装
1. clone
    ```shell
    git clone https://github.com/azkaban/azkaban.git 
    ```
2. 构建Azkaban并创建安装包
    ```shell
    cd azkaban; 
    ./gradlew build installDist
    ```
3. 启动Solo服务
    ```shell
    cd azkaban-solo-server/build/install/azkaban-solo-server
    bin/start-solo.sh
    ```
    Azkaban solo服务应该全部设置，通过 **8081默认监听端口** 接受传入的网络请求。所以，打开一
    个Web浏览器并查看 http://localhost:8081/
4. 停止服务
    ```shell
    bin/shutdown-solo.sh
    ```

Solo服务安装应包含以下目录：

| 文件夹 | 描述 |
|:------ |:------ |
| bin | 启动/停止Azkaban solo服务的脚本 |
| conf | Azkaban solo服务的配置文件 |
| lib | Azkaban的jar依赖项 |
| extlib | 添加到extlib的其他jar将添加到Azkaban的类路径中 |
| plugins | 可以安装插件的目录 |
| web | Azkaban Web服务的Web（css，javascript，image）文件 |

在`conf`目录中，应该有三个文件：
+ **azkaban.private.properties** - 由Azkaban用于存储Mysql密码等
+ **azkaban.properties** - Azkaban用于运行时参数
+ **global.properties** - 作为共享属性传递给每个工作流和作业的全局静态属性。
+ **azkaban-users.xml** - 用于添加用户和角色以进行身份​​验证。如果`XmLUserManager`未设置为
使用它，则不使用此文件。

`azkaban.properties`是主配置文件。

### 2.2.配置HTTPS服务器（可选）
**默认情况下，Azkaban solo服务不使用SSL**。但您可以在独立的Web服务器中以相同的方式设置它。方
法如下：

**Azkaban Web服务支持SSL套接字连接器，这意味着密钥库必须可用**。您可以按照步骤生成
[此处](https://wiki.eclipse.org/Jetty/Howto/Configure_SSL)提供的有效jetty密钥库。创建
密钥库文件后，必须为Azkaban提供其位置和密码。**`azkaban.properties`或`azkaban.private.properties`**
（推荐），下面的属性应该被覆盖：
```ini
jetty.keystore=keystore
jetty.password=password
jetty.keypassword=password
jetty.truststore=keystore
jetty.trustpassword=password
```
**并在`azkaban.properties`中配置ssl端口**：
```ini
jetty.ssl.port=8443
```

## 3.Multi Executor Server入门

### 3.1.数据库设置
**我们建议用户选择Mysql作为Azkaban数据库**，因为我们建立了一些Mysql连接增强功能，以方便AZ设
置，并增强服务可靠性：
+ 安装Mysql
+ 设置Mysql
    - 为Azkaban创建数据库：
        ```sql
        mysql> CREATE DATABASE azkaban;
        ```
    - 为Azkaban创建一个mysql用户。例如：
        ```sql
        mysql> CREATE USER 'username'@'%' IDENTIFIED BY 'password';
        mysql> GRANT SELECT,INSERT,UPDATE,DELETE ON azkaban.* to '<username>'@'%' WITH GRANT OPTION;
        ```
    - 可能需要重新配置Mysql数据包大小。默认情况下，MySQL可能具有可笑的低允许数据包大小。要增加
    它，您需要将属性 **max_allowed_pa​​cket** 设置为更高的数字，比如 **1024M**。要在linux中
    配置它，请打开`/etc/my.cnf`。在 **mysqld之后** 的某处，添加以下内容：
        ```ini
        [mysqld]
        ...
        max_allowed_packet=1024M
        ```
        要重新启动MySQL，您可以运行：
        ```shell
        $ sudo /sbin/service mysqld restart
        ```
+ 创建Azkaban表
    从MySQL实例上的
    [最新表语句](https://github.com/azkaban/azkaban/tree/master/azkaban-db/src/main/sql)
    运行单个表创建脚本以创建表。或者，运行构建过程生成的`create-all-sql-<version>.sql`。
    `/Users/latang/LNKDRepos/azkaban/azkaban-db/build/distributions/azkaban-db-<version>`
    在您构建azkaban-db模块之后，该位置是文件所在：
    ```shell
    cd azkaban-db; ../gradlew build installDist
    ```

### 3.2.安装Azkaban Executor Server
Azkaban Executor Server处理工作流和作业的实际执行。您可以从主分支构建最新版本。请参见 *从源
构建* 的说明。

在gradle构建之后，将包（执行程序分发`tar.gz`从build文件夹）解压缩到一个目录中。应该有以下目录。

| 文件夹 | 描述 |
|:------ |:------ |
| bin | 启动/停止Azkaban solo服务的脚本 |
| conf | Azkaban solo服务的配置文件 |
| lib | Azkaban的jar依赖项 |
| extlib | 添加到extlib的其他jar将添加到Azkaban的类路径中 |
| plugins | 可以安装插件的目录 |
| web | Azkaban Web服务的Web（css，javascript，image）文件 |

为了快速入门，我们可以直接使用gradle生成的安装目录
`azkaban/azkaban-exec-server/build/install/azkaban-exec-server`。我们只需要在里面更改
mysql用户名和密码 **azkaban.properties**：
```ini
# Mysql Configs
mysql.user=<username>
mysql.password=<password>
```
然后 **运行**：
```shell
cd azkaban-exec-server/build/install/azkaban-exec-server
./bin/start-exec.sh
```
之后，请记住通过调用以下方法 **激活执行程序**：
```shell
cd azkaban-exec-server/build/install/azkaban-exec-server
curl -G "localhost:$(<./executor.port)/executor?action=activate" && echo
```
然后，一个执行器准备好使用。用户可以通过分发和部署多个执行程序安装分发来设置多个执行程序。

### 3.3.安装Azkaban Web服务器
Azkaban Web Server处理项目管理、身份验证、计划和执行触发器。您可以从主分支构建最新版本。参见从
源构建的说明。

在gradle构建之后，将包（执行程序分发`tar.gz`从build文件夹）解压缩到一个目录中。应该有以下目录。

| 文件夹 | 描述 |
|:------ |:------ |
| bin | 启动/停止Azkaban solo服务的脚本 |
| conf | Azkaban solo服务的配置文件 |
| lib | Azkaban的jar依赖项 |
| extlib | 添加到extlib的其他jar将添加到Azkaban的类路径中 |
| plugins | 可以安装插件的目录 |
| web | Azkaban Web服务的Web（css，javascript，image）文件 |

为了快速入门，我们可以直接使用gradle生成的安装目录
`azkaban/azkaban-web-server/build/install/azkaban-web-server`。我们只需要在里面更改
mysql用户名和密码 **azkaban.properties**：
```ini
# Mysql Configs
mysql.user=<username>
mysql.password=<password>
```
然后跑：
```shell 
cd azkaban-web-server/build/install/azkaban-web-server
./bin/start-web.sh
```
然后，多执行器Azkaban实例就可以使用了。打开Web浏览器并查看http://localhost:8081/ 您已设置为
登录Azkaban UI。

## 4.设置Azkaban插件
Azkaban旨在使基于插件的非核心功能成为可能：
+ 它们可以在不同环境中有选择地安装/升级而无需更改核心Azkaban。
+ 它使Azkaban很容易扩展到不同的系统

现在，Azkaban允许使用许多不同的插件。**在Web服务器端**，有:
+ **查看器插件**，使自定义网页能够向Azkaban添加功能。一些已知的实现包括HDFS文件系统查看器和
Reportal。
+ **触发插件**，启用自定义触发方法。
+ **用户管理器插件**，启用自定义用户身份验证方法。例如，在LinkedIn中，我们有基于LDAP的用户身份
验证。
+ **警报器插件**，除了基于电子邮件的警报之外，还为用户启用不同的警报方法。

在 **执行程序服务器端**：
+ AzkabanExecutorServer上的可插入作业类型执行程序，例如hadoop生态系统组件的作业类型。

我们建议安装这些插件以最好地使用Azkaban。以下是如何安装这些插件以使用Azkaban的说明。

### 4.1.用户管理器插件
默认情况下，Azkaban附带`XMLUserManager`类，该类根据xml文件对用户进行身份验证
**conf/azkaban-users.xml**。

**这不安全**，不能为很多用户服务。**在实际生产部署中，您应该依赖自己的用户管理器类**，例如基于
LDAP的用户管理器类。该`XMLUserManager`仍可用于特殊用户帐户和管理用户角色。您可以在默认
**azkaban-users.xml** 文件中找到这两种情况的示例。

**要安装自己的用户管理器类，请在`Azkaban-web-server-install-dir/conf/azkaban.properties`
中指定：
```
user.manager.class=MyUserManagerClass
```
**并将包含jar放在plugins目录中**。

### 4.2.查看器插件

#### 4.2.1.HDFS查看器插件
HDFS查看器插件应安装在AzkabanWebServer插件目录中，该目录在AzkabanWebServer的配置文件中指定，
例如`Azkaban-web-server-install-dir/conf/azkaban.properties`：
```ini
viewer.plugins=hdfs
```
这告诉Azkaban从中 **加载hdfs viewer插件** 
`Azkaban-web-server-install-dir/plugins/viewer/hdfs`。将`azkaban-hdfs-viewer`存档解
压缩到AzkabanWebServer `./plugins/viewer`目录。将目录重命名为 **hdfs**，如上所述。

根据hadoop安装是否已打开：
1. **如果Hadoop安装没有打开安全性，则默认配置足够好**。可以简单地重启AzkabanWebServer并开始
使用HDFS查看器。
2. **如果Hadoop安装确实打开了安全性**，则应在插件的配置文件中设置以下配置，使其与默认值不同：

    | 参数 | 描述 |
    |:---- |:---- |
    | azkaban.should.proxy | Azkaban是否应该代理另一个用户来查看hdfs文件系统，而不是Azkaban本身，默认为true |
    | hadoop.security.manager.class | 要使用的安全管理器处理与安全hadoop集群的通信，默认为azkaban.security.HadoopSecurity Manager_H_1_0（适用于hadoop 1.x版本） |
    | proxy.user | Azkaban用户配置了kerberos和hadoop。类似于应如何配置oozie，用于安全的hadoop安装 |
    | proxy.keytab.location | 密钥表文件的位置，Azkaban可以使用Kerberos为指定的proxy.user进行身份验证 |

### 4.3.工作类型插件
Azkaban有一组 **有限的内置作业类型** 来运行本地unix命令和简单的java程序。在大多数情况下，您需
要安装其他作业类型插件，例如，hadoopJava，Pig，Hive，VoldemortBuildAndPush等。一些常见的插
件包含在 **azkaban-jobtype存档** 中。以下是如何安装：

**作业类型插件** 应与AzkabanExecutorServer的插件目录一起安装，并在AzkabanExecutorServer
的配置文件中指定。例如，在`Azkaban-exec-server-install-dir/conf/azkaban.properties`：
```ini
azkaban.jobtype.plugin.dir=plugins/jobtypes
```
这告诉Azkaban从中加载所有作业类型`Azkaban-exec-server-install-dir/plugins/jobtypes`。
将存档解压缩到AzkabanExecutorServer `./plugins/`目录，将其重命名 **jobtypes** 为如上所述。

运行Hadoop作业时，通常需要以下设置：

| 参数 | 描述 |
|:--- |:--- |
| `hadoop.home` | 你的`$HADOOP_HOME`设置 |
| `jobtype.global.classpath` | 集群特定的hadoop资源，例如hadoop-core jar和hadoop conf（例如 ）`${hadoop.home}/hadoop-core-1.0. 4.jar`,`${hadoop.home}/conf` |
| `proxy.keytab.location` | 密钥表文件的位置，Azkaban可以使用`Kerberos`为指定的`proxy.user`进行身份验证 |

有关更多Hadoop安全相关信息，请参阅[HadoopSecurityManager](https://azkaban.readthedocs.io/en/latest/plugins.html#hadoopsecuritymanager)。

最后，启动执行程序，注意错误消息并检查执行程序服务器日志。对于作业类型插件，执行程序应进行最低限度
的测试，并告知您是否已正确安装。

## 5.属性覆盖
Azkaban作业由一组我们称之为属性的键值对指定。有多种来源可用于决定哪些属性最终将成为作业执行的一
部分。**下表列出了所有属性来源及其优先级**。请注意，**如果某个属性出现在多个来源中，那么将使用来
自高属性来源的值**。

用户可以看到以下属性。这些是在`AbstractProcessJob.java`中合并形成`jobProp`的相同属性：

| PropertySource | 描述 | 优先级 |
|:------------- |:------ |:----- |
| `global.properties`在`conf`目录中 | Azkaban设置期间的管理员配置属性。全局所有工作类型。 | 最低（0） |
| `common.properties`在`jobtype`目录中 | Azkaban设置期间的管理员配置属性。全局所有工作类型。 | 1 ｜
| `plugin.properties`在`jobtype/<jobtype-name>`目录 | Azkaban设置期间的管理员配置属性。受限于特定的工作类型。| 2 |
| `common.properties`在项目`zip`中 | 这些是用户指定的属性，适用于兄弟或后代目录中的所有作业 | 3 |
| 触发流程执行时指定的流属性 | 这些是用户指定的属性。这些可以从UI或Ajax调用中指定，但不能保存在项目zip中。| 4 |
| `{job-name}.job`工作规范 | 这些是实际作业文件中的用户指定属性 | 最高（5） |
