Cloudera Manager API
================================================================================
Cloudera Manager API提供配置和服务生命周期管理，服务健康信息和指标，并允许您自行配置Cloudera Manager。
该API与Cloudera Manager管理控制台在相同的主机和端口上提供，并且不需要额外的进程或额外的配置。该API支持
HTTP基本身份验证，接受与Cloudera Manager管理控制台相同的用户和凭据。

## 1.资源
+ [快速开始](http://cloudera.github.io/cm_api/docs/quick-start/)
+ [Cloudera Manager API教程](http://cloudera.github.io/cm_api/apidocs/v19/tutorial.html)
+ [Cloudera Manager API文档](http://cloudera.github.io/cm_api/apidocs/v19/)
+ [Python客户端](http://cloudera.github.io/cm_api/docs/python-client/)
+ [使用Cloudera Manager API进行群集自动化](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_intro_automation_api.html#xd_583c10bfdbd326ba--7f25092b-13fba2465e5--7f17)

## 2.获取配置文件
1. 获取服务角色的列表：
```
http://cm_server_host:7180/api/v19/clusters/clusterName/services/serviceName/roles
```
2. 获取进程正在使用的配置文件的列表：
```
http://cm_server_host:7180/api/v19/clusters/clusterName/services/serviceName/roles/roleName/process
```
3. 获取任何特定文件的内容：
```
http://cm_server_host:7180/api/v19/clusters/clusterName/services/serviceName/roles/roleName/process/configFiles/configFileName
```
例如：
```
http://cm_server_host:7180/api/v19/clusters/Cluster%201/services/OOZIE-1/roles/OOZIE-1-OOZIE_SERVER-e121641328fcb107999f2b5fd856880d/process/configFiles/oozie-site.xml
```

## 3.检索服务和主机属性
要使用Cloudera Manager API更新服务属性，您需要知道属性的名称，而不仅仅是显示名称。如果您知道属性的显示名称，
但不知道属性名称，请通过向URL中添加查询字符串 view=FULL 请求任何配置对象来检索文档。例如：
```
http://cm_server_host:7180/api/v19/clusters/Cluster%201/services/service_name/config?view=FULL
```
搜索结果以获取所需属性的显示名称。例如，搜索显示名称HDFS服务环境高级配置代码段（安全阀），显示相应的属性名称为
hdfs_service_env_safety_valve：
```json
{
   "name" : "hdfs_service_env_safety_valve",
   "require" : false,
   "displayName" : "HDFS Service Environment Advanced Configuration Snippet (Safety Valve)",
   "description" : "For advanced use onlyu, key/value pairs (one on each line) to be inserted into a roles
   environment. Applies to configurations of all roles in this service except client configuration.",
   "relatedName" : "",
   "validationState" : "OK"
}
```
与查找服务属性类似，您也可以查找主机属性。首先，获取具有以下URL的群集的主机ID：
```
http://cm_server_host:7180/api/v19/hosts
```
这应该返回表单的主机对象：
```
{
   "hostId" : "2c2e951c-aaf2-4780-a69f-0382181f1821",
   "ipAddress" : "10.30.195.116",
   "hostname" : "cm_server_host",
   "rackId" : "/default",
   "hostUrl" : "http://cm_server_host:7180/cmf/hostRedirect/2c2e951c-adf2-4780-a69f-0382181f1821",
   "maintenanceMode" : false,
   "maintenanceOwners" : [ ],
   "commissionState" : "COMMISSIONED",
   "numCores" : 4,
   "totalPhysMemBytes" : 10371174400
}
```
然后通过在URL中包含返回的主机ID之一来获取主机属性：
```
http://cm_server_host:7180/api/v19/hosts/2c2e951c-adf2-4780-a69f-0382181f1821?view=FULL
```

## 4.备份和恢复Cloudera Manager配置
您可以使用Cloudera Manager REST API来导出和导入其所有配置数据。API将导出一个包含Cloudera Manager
实例的配置数据的JSON文档。您可以使用此JSON文档来备份和恢复Cloudera Manager部署。

最低要求的角色：群集管理员（也由完全管理员提供）。

### 4.1.导出Cloudera Manager配置
1. 以root用户身份登录到Cloudera Manager服务器主机。
2. 运行以下命令：
    ```
    # curl -u admin_uname:admin_pass "http://cm_server_host:7180/api/v19/cm/deployment" > path_to_file/cm-deployment.json
    ```
    + admin_uname是具有完全管理员或群集管理员角色的用户名。
    + admin_pass是admin_uname用户名的密码。
    + cm_server_host是Cloudera Manager服务器的主机名。
    + path_to_file是要保存配置的文件的路径。

### 4.2.从导出的配置中减少敏感信息
导出的配置可能包含密码和其他敏感信息。您可以通过为Cloudera Manager指定JVM参数来配置敏感项目的编辑。
设置此参数时，针对配置数据的API调用Cloudera Manager不包含敏感信息。
```
重要提示：如果您配置此新版本，则由于编辑信息，您无法使用导出的配置来恢复群集配置。
```
为API配置编辑：
1. 登录Cloudera Manager服务器主机。
2. 通过将以下属性（用空格分隔每个属性）添加到以导出CMF_JAVA_OPTS开头的行来编辑/etc/default/cloudera-scm-server文件：
    ```
    -Dcom.cloudera.api.redaction=true
    ```
3. 重新启动Cloudera Manager：
    ```shell
    $ sudo service cloudera-scm-server restart
    ```

### 4.3.恢复Cloudera Manager配置
```
重要提示：此功能需要Cloudera Enterprise许可证。 它在Cloudera Express中不可用。 有关更多信息，请参阅管理许可证。
```
使用先前保存的包含Cloudera Manager配置数据的JSON文档，可以将该配置恢复到正在运行的群集。
1. 使用Cloudera Manager管理控制台，停止群集中的所有正在运行的服务：
    + 在 主页>状态 选项卡上，单击群集名称右侧的 ![按钮](img/20.png)，然后选择停止。
    + 点击确认屏幕上的停止。Command Details窗口显示停止服务的进度。出现所有服务成功停止时，任务已完成，
    您可以关闭“命令详细信息”窗口。
2. 以root用户身份登录到Cloudera Manager服务器主机。
3. 运行以下命令：
  ```shell
  curl --upload-file path_to_file/cm-deployment.json -u admin_uname:admin_pass http://cm_server_host:7180/api/v19/cm/deployment?deleteCurrentDeployment=true
  ```
    + admin_uname是具有完全管理员或群集管理员角色的用户名。
    + admin_pass是admin_uname用户名的密码。
    + cm_server_host是Cloudera Manager服务器的主机名。
    + path_to_file是包含JSON配置文件的文件的路径。

## 5.使用Cloudera Manager API进行群集自动化
Apache Hadoop的复杂之处在于需要定期部署服务器集群。如果您将数百个测试和开发集群维护在不同的配置中，
那么如果不自动进行，此过程可能会非常复杂和繁琐。

### 5.1.集群自动化用例
集群自动化在各种情况下都很有用。例如，您可能在多种版本的CDH上工作，这些版本适用于各种操作系统发行版
（RHEL 5和RHEL 6，Ubuntu Precise和Lucid，Debian Wheezy和SLES 11）。您可能有复杂的配置组合 -
高可用的HDFS或简单HDFS，Kerberized或非安全，YARN或MRv1等。有了这些要求，您需要一种简单的方法来创
建具有所需设置的新群集。该集群还可用于集成，测试，客户支持，演示和其他目的。

您可以使用Cloudera Manager REST API根据精确的规格来安装和配置Hadoop。使用API，您可以添加主机，
安装CDH，并定义集群及其服务。您还可以调整堆大小，设置HDFS HA，打开Kerberos安全性并生成密钥表，以
及自定义服务目录和端口。在Cloudera Manager中可用的每个配置都在API中公开。

API还提供对管理功能的访问：
+ 获取日志并监视系统
+ 开始和停止服务
+ 轮询群集事件
+ 创建灾难恢复复制计划

例如，您可以使用API从HDFS，HBase或任何其他服务中检索日志，而无需知道日志位置。您也可以停止任何服务，
无需额外的步骤。

使用Cloudera Manager API进行集群自动化的场景可能包括：
+ OEM和硬件合作伙伴使用API提供Hadoop-in-a-box设备，以在工厂裸设置CDH和Cloudera Manager。
+ 使用Puppet和Cloudera Manager API的组合自动部署新群集。Puppet执行操作系统级配置并安装软件。
Cloudera Manager API设置Hadoop服务并配置群集。
+ 将API与报告和警报基础架构集成。外部脚本可以轮询API以了解运行状况和指标信息，以及事件和警报流，
以便将其馈送到自定义仪表板。

### 5.2.Java API示例
这个例子涵盖了Java API客户端。

要使用Java客户端，请将此依赖项添加到项目的pom.xml中：
```xml
<project>
  <repositories>
    <repository>
      <id>cdh.repo</id>
      <url>https://repository.cloudera.comgroups/cloudera-repos</url>
      <name>Cloudera Repository</name>
    </repository>
    …
  </repositories>
  <dependencies>
    <dependency>
      <groupId>com.cloudera.api</groupId>
      <artifactId>cloudera-manager-api</artifactId>
      <version>4.6.2</version>      <!-- Set to the version of Cloudera Manager you use -->
    </dependency>
    …
  </dependencies>
  ...
</project>
```
Java客户端就像一个代理。它从调用者隐藏关于REST，HTTP和JSON的任何细节。入口点是API根的句柄：
```Java
RootResourcev19 apiRoot = new ClouderaManagerClientBuilder()
    .withHost("cm.cloudera.com")
    .withUsernamePassword("admin", "admin")
    .build()
    .getRootv19();
```
从根部开始，您可以遍历所有其他资源。（因为这是当前的Cloudera Manager API版本，所以它被称为“v19”，
但同一构建器也会从早期版本的API返回一个根。）树视图显示一些关键资源和支持的操作：
+ RootResourcev19
    - lustersResourcev19 - 主机成员资格，启动集群
        + ServicesResourcev19 - 配置，获取指标，HA，服务命令
            - RolesResource - 添加角色，获取指标，日志
            - RoleConfigGroupsResource - 配置
        + ParcelsResource - parcel管理
+ HostsResource - 主机管理，获取指标
+ UsersResource - 用户管理

有关更多信息，请参阅Javadoc。

以下示例列出并启动一个集群：
```java
// List of clusters
ApiClusterList clusters = apiRoot.getClustersResource().readClusters(DataView.SUMMARY);
for (ApiCluster cluster : clusters) {
  LOG.info("{}: {}", cluster.getName(), cluster.getVersion());
}

// Start the first cluster
ApiCommand cmd = apiRoot.getClustersResource().startCommand(clusters.get(0).getName());
while (cmd.isActive()) {
   Thread.sleep(100);
   cmd = apiRoot.getCommandsResource().readCommand(cmd.getId());
}
LOG.info("Cluster start {}", cmd.getSuccess() ? "succeeded" : "failed " + cmd.getResultMessage());
```

### 5.3.Python示例
您可以在以下链接中看到使用Python进行自动化的示例：
[Python示例](https://github.com/cloudera/cm_api/tree/master/python/examples/auto-deploy)。
该示例包含有关自动执行群集部署的要求和步骤的信息。
