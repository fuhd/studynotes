第4步：安装和配置数据库
================================================================================
Cloudera Manager使用各种数据库和数据存储来存储有关Cloudera Manager配置的信息，以及诸如系统运行
状况或任务进度等信息。

虽然您可以在单个环境中部署不同类型的数据库，但这样做可能会产生意外的复杂情况。**Cloudera建议为所有
Cloudera数据库选择一个受支持的数据库提供程序**。

**Cloudera建议将数据库安装在与服务不同的主机上**。将数据库与服务分离可以帮助隔离来自某个或另一个的
故障或资源争夺的潜在影响。它还可以简化具有专用数据库管理员的组织的管理。

您可以将自己的 **PostgreSQL，MariaDB，MySQL或Oracle** 数据库用于Cloudera Manager Server和其
他使用数据库的服务。有关规划，管理和备份Cloudera Manager数据存储的信息，请参阅
[Cloudera Manager的存储空间规划](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_reqs_space.html#concept_tjd_4yc_gr)和[备份数据库](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ag_backup_dbs.html#xd_583c10bfdbd326ba--6eed2fb8-14349d04bee--7e98)。

## 1.所需的数据库
以下组件都需要数据库：**Cloudera Manager服务，Oozie服务，Sqoop服务，活动监视器，报表管理器，
Hive Metastore服务，Hue服务，Sentry服务，Cloudera Navigator Audit服务和Cloudera Navigator
Metadata服务**。数据库中包含的数据类型及其相对大小如下所示：
+ **Cloudera Manager服务** - 包含有关已配置的服务及其角色分配，所有配置历史记录，命令，用户和运行
进程的所有信息。这个相对较小的数据库（ **<100 MB** ）是 **备份最重要的数据库**。
    ```
    重要提示：重新启动进程时，将使用保存在Cloudera Manager数据库中的信息重新部署每个服务的配置。如果此信息不可用，
    您的群集无法启动或正常工作。您必须安排并维护Cloudera Manager数据库的定期备份才能在发生此数据库丢失时恢复群集。
    有关更多信息，请参阅备份数据库。
    ```
+ **Oozie服务** - 包含Oozie工作流程，协调器和绑定数据。**可以长得很大**。
+ **Sqoop服务** - 包含诸如连接器，驱动程序，链接和作业等实体。**相对较小**。
+ **活动监视器** - 包含有关过去活动的信息。在大型集群中，该数据库可能会变大。**只有部署了MapReduce
服务时，才需要配置Activity Monitor数据库**。
+ **报告管理器** - 随时间追踪磁盘利用率和处理活动。**中型**。
+ **Hive Metastore服务** - 包含Hive元数据。**相对较小**。
+ **Hue服务** - 包含用户帐户信息，作业提交和Hive查询。**相对较小**。
+ **Sentry服务** - 包含授权元数据。**相对较小**。
+ **Cloudera Navigator审计服务** - 包含审计信息。在大型集群中，**该数据库可能会变大**。
+ **Cloudera Navigator元数据服务** - 包含授权，策略和审计报告元数据。**相对较小**。

主机监视器和服务监视器服务使用本地基于磁盘的数据存储。有关更多信息，请参阅监控数据的数据存储。

**数据库的JDBC连接器必须安装在分配活动监视器和报告管理器角色的主机上**。

## 2.安装和配置数据库
有关为Cloudera Manager，CDH和其他托管服务安装和配置数据库的说明，请参阅有关要使用的数据库类型的
说明。

### 2.1.安装和配置MySQL

#### 2.1.1.安装MySQL服务器
```
注意：

1. 如果您已经设置了MySQL数据库，则可以跳到配置和启动MySQL服务器部分，以验证您的MySQL配置是否满足Cloudera Manager的要求
2. 对于MySQL5.6和5.7，您必须安装MySQL-shared-compat或MySQL共享软件包。这是Cloudera Manager Agent软件包安装必需的
3. datadir目录（缺省情况下为 /var/lib/mysql）位于具有足够可用空间的分区上很重要
4. 如果在MySQL中启用基于GTID的复制，则Cloudera Manager安装将失败
```
这里只针对CentOS/RHEL操作系统：

**MySQL不再包含在RHEL中。您必须从MySQL网站下载存储库并直接安装它**。您可以使用以下命令来安装MySQL。
欲了解更多信息，请访问 [MySQL网站](https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/)。
```shell
$ wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm
$ sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm
$ sudo yum update
$ sudo yum install mysql-server
$ sudo systemctl start mysqld
```

#### 2.1.2.配置和启动MySQL服务器
```
注意:如果要对现有数据库进行更改，请确保在继续之前停止任何使用该数据库的服务。
```
1. 如果MySQL服务器正在运行，请停止
  + 兼容RHEL7
      ```shell
      $ sudo systemctl stop mysqld
      ```
  + 兼容RHEL6
      ```shell
      $ sudo service mysqld stop
      ```
2. 将旧的InnoDB日志文件 **/var/lib/mysql/ib_logfile0** 和 **/var/lib/mysql/ib_logfile1**
移出 **/var/lib/mysql/**，放到备份位置。
3. 确定选项文件 **my.cnf**（默认为 **/etc/my.cnf** ）的位置。
4. 更新 **my.cnf**，使其符合以下要求：
  + 为防止死锁，请将 **隔离级别** 设置为 **READ-COMMITTED**。
  + 配置InnoDB引擎。**如果使用MyISAM引擎配置表，Cloudera Manager将不会启动**。（通常，如果InnoDB
  引擎配置错误，表会恢复为MyISAM。）要检查表使用的是哪个引擎，请从MySQL shell运行以下命令：
      ```sql
      mysql> show table status;
      ```
  + 大多数发行版中的MySQL安装中的 **默认设置使用保守的缓冲区大小和内存使用情况**。Cloudera管理服务角
  色需要高写入吞吐量，因为它们可能会在数据库中插入许多记录。**Cloudera建议您将innodb_flush_method
  属性设置为O_DIRECT**。
  + 根据群集的大小设置 **max_connections** 属性：
    - **少于50个主机** - 您可以在同一主机上存储多个数据库（例如，活动监视器和服务监视器）。如果你这样
    做，你应该：
      + 将每个数据库放在其自己的存储卷上。
      + 为每个数据库允许最多100个连接，然后添加50个额外的连接。例如，对于两个数据库，将最大连接数设置
      为250。如果在一台主机上存储5个数据库（Cloudera Manager服务器，活动监视器，报告管理器，Cloudera
      导航器和Hive Metastore的数据库），请将最大连接数设置为550。
    - **超过50个主机** - 不要在同一个主机上存储多个数据库。为每个数据库/主机对使用一个单独的主机。主
    机不需要为数据库专门保留，但每个数据库应该位于单独的主机上。
  + 二进制日志记录不是Cloudera Manager安装的要求。二进制日志记录提供了诸如MySQL复制或数据库恢复之后
  的时间点增量恢复等优点。这个配置的例子如下。有关更多信息，请参阅[二进制日志](https://dev.mysql.com/doc/refman/8.0/en/binary-log.html)。

  这是一个包含Cloudera推荐设置的选项文件：
  ```ini
  [mysqld]
  datadir=/var/lib/mysql
  socket=/var/lib/mysql/mysql.sock
  transaction-isolation = READ-COMMITTED
  # Disabling symbolic-links is recommended to prevent assorted security risks;
  # to do so, uncomment this line:
  symbolic-links = 0

  key_buffer_size = 32M
  max_allowed_packet = 32M
  thread_stack = 256K
  thread_cache_size = 64
  query_cache_limit = 8M
  query_cache_size = 64M
  query_cache_type = 1

  max_connections = 550
  #expire_logs_days = 10
  #max_binlog_size = 100M

  #log_bin should be on a disk with enough free space.
  #Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your
  #system and chown the specified folder to the mysql user.
  log_bin=/var/lib/mysql/mysql_binary_log

  #In later versions of MySQL, if you enable the binary log and do not set
  #a server_id, MySQL will not start. The server_id must be unique within
  #the replicating group.
  server_id=1

  binlog_format = mixed

  read_buffer_size = 2M
  read_rnd_buffer_size = 16M
  sort_buffer_size = 8M
  join_buffer_size = 8M

  # InnoDB settings
  innodb_file_per_table = 1
  innodb_flush_log_at_trx_commit  = 2
  innodb_log_buffer_size = 64M
  innodb_buffer_pool_size = 4G
  innodb_thread_concurrency = 8
  innodb_flush_method = O_DIRECT
  innodb_log_file_size = 512M

  [mysqld_safe]
  log-error=/var/log/mysqld.log
  pid-file=/var/run/mysqld/mysqld.pid

  sql_mode=STRICT_ALL_TABLES
  ```
5. 如果AppArmor正在安装MySQL的主机上运行，则可能需要配置AppArmor以允许MySQL写入二进制文件。
6. 确保MySQL服务器在系统启动时启动：
  + **兼容RHEL7**
      ```shell
      $ sudo systemctl enable mysqld
      ```
  + **兼容RHEL6**
      ```shell
      $ sudo chkconfig mysqld on
      ```
7. 启动MySQL服务器：
  + **兼容RHEL7**
      ```shell
      $ sudo systemctl start mysqld
      ```
  + **兼容RHEL6**
      ```shell
      $ sudo service mysqld start
      ```
8. 运行 **/usr/bin/mysql_secure_installation** 以设置MySQL **root密码** 和其他安全相关设置。
在新安装中，根密码为空。当系统提示您输入根密码时，请按Enter键。对于其他提示，请输入下面以粗体显示的回复：
  ```shell
  $ sudo /usr/bin/mysql_secure_installation
  ```
  ```
  [...]
  Enter current password for root (enter for none):
  OK, successfully used password, moving on...
  [...]
  Set root password? [Y/n] Y
  New password:
  Re-enter new password:
  Remove anonymous users? [Y/n] Y
  [...]
  Disallow root login remotely? [Y/n] N
  [...]
  Remove test database and access to it [Y/n] Y
  [...]
  Reload privilege tables now? [Y/n] Y
  All done!
  ```

#### 2.1.3.安装MySQL JDBC驱动程序
在Cloudera Manager服务器主机以及运行需要数据库访问的服务的任何其他主机上安装JDBC驱动程序。有关使
用数据库的Cloudera软件的更多信息，请参阅 [必需的数据库](https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_installing_configuring_dbs.html#cmig_topic_5_1)。
```
注意：如果您已经在需要它的主机上安装了JDBC驱动程序，则可以跳过本节。但是，MySQL5.6需要5.1.26或更高版本的驱动程序。
```
**Cloudera建议您在有限数量的主机上合并所有需要数据库的角色，并在这些主机上安装驱动程序。在同一主机上
查找所有这些角色是推荐的**，但不是必需的。确保在运行访问数据库的角色的每台主机上安装JDBC驱动程序。

+ **RHEL**
  ```
  重要说明：
  不要使用yum install命令安装MySQL驱动程序包，因为它安装了OpenJDK，然后使用Linux alternatives命令将系统JDK
  设置为OpenJDK。
  ```
  1. 从 http://www.mysql.com/downloads/connector/j/5.1.html（以.tar.gz格式）下载MySQL
  JDBC驱动程序。
  2. 从下载的文件中提取JDBC驱动程序JAR文件。 例如：
      ```shell
      $ tar zxvf mysql-connector-java-5.1.46.tar.gz
      ```
  3. 将重命名的JDBC驱动程序复制到 **/usr/share/java/**。如果目标目录尚不存在，请创建它。例如：
      ```shell
      $ sudo mkdir -p /usr/share/java/
      $ cd mysql-connector-java-5.1.46
      $ sudo cp mysql-connector-java-5.1.46-bin.jar /usr/share/java/mysql-connector-java.jar
      ```

#### 2.1.4.为Cloudera软件创建数据库
为需要数据库的组件创建数据库和服务帐户：
+ Cloudera Manager Server
+ Cloudera管理服务角色：
  - 活动监视器（如果在CDH5集群中使用MapReduce服务）
  - 报告管理器
+ 各个Hive metastore
+ Sentry Server
+ Cloudera Navigator审计服务器
+ Cloudera Navigator元数据服务器

**数据库必须配置为支持MySQL utf8字符集编码**。

记录您输入的 **数据库名称，用户名和密码** 的值。Cloudera Manager安装向导需要此信息才能正确连接到这
些数据库。
1. 以 **root用户** 或具有创建数据库和授予权限的其他用户身份登录：
    ```shell
    mysql -u root -p
    Enter password:
    ```
2. 从下表中为您正在使用的每个服务创建数据库：
    ```
    mysql> CREATE DATABASE <database> DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
    Query OK, 1 row affected (0.00 sec)

    mysql> GRANT ALL ON <database>.* TO '<user>'@'%' IDENTIFIED BY '<password>';
    Query OK, 0 rows affected (0.00 sec)
    ```
    您可以使用<database>，<user>和<password>的任何值。以下示例是Cloudera Manager配置设置中提供
    的默认名称，但您不需要使用它们：

    Cloudera软件的数据库：

    | 服务 | 数据库 | 用户 |
    | :------------- | :------------- | :------------- |
    | Cloudera Manager Server | scm | scm |
    | Activity Monitor | amon | amon |
    | Reports Manager | rman | rman |
    | Hue | hue | hue |
    | Hive Metastore Server | metastore | hive |
    | Sentry Server | sentry | sentry |
    | Cloudera Navigator Audit Server | nav | nav |
    | Cloudera Navigator Metadata Server | navms | navms |
    | Oozie | oozie | oozie |

3. 确认您已经创建了所有的数据库：
    ```shell
    mysql> SHOW DATABASES;
    ```
    您还可以运行以下命令确认给定用户的权限授予：
    ```shell
    mysql> SHOW GRANTS FOR '<user>'@'%';
    ```

### 2.2.安装和配置Cloudera软件的MariaDB
