卸载Cloudera Manager和托管软件
================================================================================
使用以下说明卸载Cloudera Manager服务器，客户端，受管软件和数据库。

## 卸载Cloudera Manager和托管软件
按照本节中的步骤删除软件和数据。

### 1.记录用户数据路径
列出的用户数据路径 **删除用户数据**。
```
/var/lib/flume-ng
/var/lib/hadoop*
/var/lib/hue
/var/lib/navigator
/var/lib/oozie
/var/lib/solr
/var/lib/sqoop*
/var/lib/zookeeper

data_drive_path/dfs
data_drive_path/mapred
data_drive_path/yarn
```
是默认设置。但是，在某些时候，它们可能已在Cloudera Manager中重新配置。如果要从群集中删除所有用户数据
并更改路径，则在安装CDH和托管服务时或稍后，请通过检查每个服务中的配置来记录路径的位置。

## 2.停止所有服务
对于由Cloudera Manager管理的每个群集：
1. 对于由Cloudera Manager管理的每个群集：
    1. 在 **主页>状态** 选项卡上，单击群集名称右侧的 ![下拉框](img/1.png)，然后选择停止。
    2. 单击确认屏幕中的“停止”。"命令详细信息"窗口显示停止服务的进度。当出现所有服务成功停止时，任务完成，
    您可以关闭“命令详细信息”窗口。
2. 在 **主页>状态** 选项卡上，单击Cloudera Management Service条目右侧的 ![下拉框](img/1.png)，
然后选择停止。"命令详细信息"窗口显示停止服务的进度。当出现所有服务成功停止时，任务完成，您可以关闭“命令详细
信息”窗口。

## 3.停用和删除Parcels
如果使用packages进行安装，请跳过此步骤并转至 **卸载Cloudera Manager Server**；您将在 **卸载Cloudera
Manager Agent和Managed Software** 中删除packages。如果您使用Parcels进行安装，请按如下方式将其删除：
1. 单击主导航栏中的parcel指示器 ![parcels图标](img/2.png)。
2. 在左侧的 **位置** 选择器中，选择 **All Clusters**。
3. 对于每个激活的parcel，请选择“**操作**”>“**取消激活**”。此操作完成后，parcel按钮将变为 **激活**。
4. 对于每个激活的parcel，请选择 **操作>从主机中删除**。此操作完成后，parcel按钮将更改为“**分发**”。
5. 对于每个激活的parcel，选择“**操作**”>“**删除**”。这将从本地parcel存储库中删除parcel。

可能存在已下载和分发的多个parcels，但这些parcel不活跃。如果是这种情况，则还应从已分发的主机中删除这些
parcels，然后从本地存储库中删除parcel。

## 4.删除群集
在 **主页** 上，单击要删除的群集旁边的下拉列表，然后选择“**删除**”。

## 5.卸载Cloudera Manager Server
卸载Cloudera Manager Server的命令取决于您用于安装它的方法。请参阅以下与您用于安装Cloudera Manager
Server的方法相对应的步骤。
+ **如果使用了cloudera-manager-installer.bin文件** - 在Cloudera Manager Server主机上运行以下
命令：
    ```shell
    $ sudo /usr/share/cmf/uninstall-cloudera-manager.sh
    ```
+ **如果未使用cloudera-manager-installer.bin文件** - 如果使用其他安装方法（如Puppet）安装Cloudera
Manager Server，请在Cloudera Manager Server主机上运行以下命令。
    1. 停止Cloudera Manager Server及其数据库：
        ```shell
        $ sudo service cloudera-scm-server stop
        $ sudo service cloudera-scm-server-db stop
        ```
    2. 卸载Cloudera Manager Server及其数据库。如果您安装了该选项，则此过程也会删除嵌入式PostgreSQL数据
    库软件。**如果您没有使用嵌入式PostgreSQL数据库，请省略`cloudera-manager-server-db`步骤**。

        RHEL系统：
          ```shell
          $ sudo yum remove cloudera-manager-server
          $ ssudo yum remove cloudera-manager-server-db-2
          ```

## 6.卸载Cloudera Manager Agent和托管软件
在所有代理主机上执行以下操作：
1. 停止Cloudera Manager Agent。
    **RHEL兼容7和更高版本：**
    ```shell
    $ sudo service cloudera-scm-agent next_stop_hard
    $ sudo service cloudera-scm-agent stop
    ```

    **所有其他RHEL/SLES系统：**
    ```shell
    $ sudo service cloudera-scm-agent hard_stop
    ```
2. 卸载软件：

    | 操作系统 | Parcel安装 |
    | :------------- | :------------- |
    | RHEL | `$ sudo yum remove 'cloudera-manager-*'` |
3. 运行clean命令：
    **RHEL：**
    ```shell
    $ sudo yum clean all
    ```

## 7.删除Cloudera Manager和用户数据

### 7.1.终止Cloudera Manager和受管进程
在所有代理主机上，终止正在运行的Cloudera Manager和受管进程：
```shell
$ for u in cloudera-scm flume hadoop hdfs hbase hive httpfs hue impala llama mapred oozie solr spark sqoop sqoop2 yarn zookeeper; do sudo kill $(ps -u $u -o pid=); done
```
```
注意：如果正确停止所有服务和Cloudera Manager Agent，则无需执行此步骤。
```

### 7.2.删除Cloudera Manager数据
如果要在 **RHEL** 上卸载，请在所有代理主机上运行以下命令以永久删除Cloudera Manager数据。如果您希
望以后能够访问任何此类数据，则必须先将其备份，然后再将其删除。如果您使用的是嵌入式PostgreSQL数据库，
则该数据存储在 `/var/lib/cloudera-scm-server-db`中。
```shell
$ sudo umount cm_processes
$ sudo rm -Rf /usr/share/cmf /var/lib/cloudera* /var/cache/yum/cloudera* /var/log/cloudera* /var/run/cloudera*
```

### 7.3.删除Cloudera Manager Lock文件
在所有代理主机上，运行以下命令以删除Cloudera Manager Lock文件：
```shell
$ sudo rm /tmp/.scm_prepare_node.lock
```

### 7.4.删除用户数据
此步骤将永久删除所有用户数据。要保留数据，请在开始卸载过程之前使用 **distcp命令** 将其复制到另一个群集。
在所有代理主机上，运行以下命令：
```shell
$ sudo rm -Rf /var/lib/flume-ng /var/lib/hadoop* /var/lib/hue /var/lib/navigator /var/lib/oozie /var/lib/solr /var/lib/sqoop* /var/lib/zookeeper
```
在所有Agent主机上的 **每个数据驱动器** 上运行以下命令（**调整每个主机上数据驱动器的路径**）：
```shell
# data_drive_path要替换成自己机器上的具体路径
$ sudo rm -Rf data_drive_path/dfs data_drive_path/mapred data_drive_path/yarn
```
```
注意：有关卸载CDH的其他信息（包括清理CDH文件），请参阅卸载CDH组件。
```

### 7.5.停止并删除外部数据库
如果选择将Cloudera Manager或用户数据存储在外部数据库中，请参阅数据库供应商文档以获取有关如何删除
数据库的详细信息。
