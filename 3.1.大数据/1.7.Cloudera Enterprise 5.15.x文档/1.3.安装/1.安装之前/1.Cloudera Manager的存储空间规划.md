Cloudera Manager的存储空间规划
================================================================================
**最低要求的角色：完全管理员**

Cloudera Manager在许多后台进程中跟踪服务，作业和应用程序的度量。所有这些指标都需要存储。根据组织的规模，
此存储可以是本地或远程的，基于磁盘的或存储在数据库中，由您或另一个位置的其他团队管理。

大多数系统管理员都知道像 /var/log/ 这样的常见位置，并且需要这些位置有足够的空间。**本主题可帮助您规划
Cloudera Manager Server和Cloudera Management Service用于存储指标和数据的存储需求和数据存储位置**。

无法规划Cloudera Manager Server和Cloudera Management Service的所有组件的存储需求可能会以下列方式
对您的群集产生负面影响：
+ 集群可能无法保留历史运营数据以满足内部要求。
+ 群集可能会错过未收集或保留所需时间长度的关键审计信息。
+ 管理员可能无法研究过去的事件或健康状况。
+ 当以后需要引用或报告时，管理员可能没有历史MR1，YARN或Impala使用数据。
+ 指标收集和图表可能存在差距。
+ 由于将存储位置填充到容量的100％，群集可能会遇到数据丢失。 这种事件的影响可能会影响许多其他组件。

**这里的主要主题是您必须提前完善您的数据存储需求。您必须通知您的运营人员有关每台主机的关键数据存储位置，
以便他们可以充分配置您的基础架构并进行适当备份。确保在内部构建文档和运行书中记录发现的需求**。

本主题介绍 **本地磁盘存储和RDBMS存储**。这种区别既可用于存储规划，也可用于通知角色从一台主机迁移到
另一台主机，准备备份和其他生命周期管理事件。

**下表提供了有关每个Cloudera管理服务的详细信息，以便Cloudera Manager管理员能够制定适当的存储和生命
周期规划决策**。

## 1.Cloudera Manager Server

| 配置主题 | Cloudera Manager服务器配置 |
| :------------- | :------------- |
| 默认存储位置 | **RDBMS**：任何支持的RDBMS。有关更多信息，请参阅CDH和Cloudera Manager支持的数据库。**磁盘**：Cloudera Manager Server本地数据存储目录（command_storage_path）配置为运行Cloudera Manager Server的主机。Cloudera Manager使用此本地路径来存储数据，包括命令结果文件。关键配置不存储在此位置。**默认设置：/var/lib/cloudera-scm-server/** |
| 存储配置 **默认值，最小值或最大值** | 没有与此实体相关的直接存储默认值。 |
| 何处控制数据保留或大小 | Cloudera Manager Server数据库的大小取决于托管主机的数量以及群集中运行的离散命令的数量。要在Cloudera Manager管理控制台中配置保留的命令的大小，请选择 **Administration> Settings** 并编辑以下属性：**Command Eviction Age**，非活动命令从数据库中逐出的时间长度。默认是两年。 |
| 规模，规划和最佳实践 | Cloudera Manager Server数据库是Cloudera Manager部署中最重要的配置存储。此数据库保存用于定义Cloudera Manager及其托管主机的部署的群集，服务，角色和其他必要信息的配置。确保您执行Cloudera Manager Server数据库的定期，经过验证的远程存储备份。 |

## 2.Cloudera Management Service

### 2.1.Cloudera管理服务 - 活动监视器配置

| 配置主题 | 活动监视器 |
| :------------- | :------------- |
| 默认存储位置 | 任何支持的RDBMS。有关更多信息，请参阅CDH和Cloudera Manager支持的数据库。 |
| 存储配置 **默认值/最小值/最大值** | 默认值：14天的MapReduce（MRv1）作业/任务 |
| 何处控制数据保留或大小 | 您可以通过配置要保留的数据天数或小时数来控制活动监视器的存储使用情况。旧数据已清除。要在Cloudera Manager管理控制台中配置数据保留，请执行以下操作：1.转到Cloudera管理服务。2.单击 **配置** 选项卡。3.选择作用域`>`活动监视器或Cloudera管理服务（服务范围）。4.选择 **类别>主**。5.找到以下属性或通过在搜索框中键入属性名称来搜索它们：**Purge Activities Data at This Age(清除活动数据)** - 在活动监视器中，清除有关MapReduce作业的数据，并在数据达到此时间后以小时为单位汇总活动。 默认情况下，活动监视器将有关活动的数据保留336小时（14天）。**Purge Attempts Data at This Age(清除尝试数据)** - 在活动监视器中，当数据达到这个年龄时，清除有关MapReduce的数据尝试。 由于尝试数据可能消耗大量数据库空间，因此您可能希望比活动数据更频繁地清除它。 默认情况下，活动监视器保留关于尝试336小时（14天）的数据。**Purge MapReduce Service Data at This Age(清除MapReduce服务数据)** - 要保留在活动监视器数据库中的过去服务级别数据的小时数，例如运行的总插槽数。 默认设置是保持336小时（14天）的数据。6.点击 **保存更改** 以提交更改。 |
| 规模，规划和最佳实践 | 活动监视器只监视MapReduce作业，不监视YARN应用程序。如果您不再在群集中使用MapReduce（MRv1），则Cloudera Manager5（或更高版本）或CDH5（或更高版本）不需要活动监视器。为期14天的MapReduce活动所需的存储空间量可能会有很大差异，并且直接取决于群集大小以及使用MapReduce的活动级别。在确定群集中MapReduce活动的“稳定状态”和“突发状态”时，可能需要调整和重新调整存储量。例如，请考虑以下测试集群和用法：1.一个模拟的1000个主机群集，每个主机都有32个插槽；2.每个活动（作业）有200次尝试（任务）的MapReduce作业调整此集群的观察值；3.每次尝试需要10分钟才能完成。4.这种用法每天导致约2万个工作，总共尝试约500万次。5.对于7天的保留期限，此活动监视器数据库需要200 GB。 |

### 2.2.Cloudera管理服务 - 服务监视器配置

| 配置主题 | 服务监视器配置 |
| :------------- | :------------- |
| 默认存储位置 | **/var/lib/cloudera-service-monitor/** 位于配置Service Monitor角色运行的主机上。 |
| 存储配置 **默认值/最小值/最大值** | 1.10GiB服务时间序列存储；1GiB Impala查询存储；1GiB YARN应用程序存储；总计：〜12GiB最小值（无最大值） |
| 何处控制数据保留或大小 | Service Monitor数据增长是通过配置它可以使用的最大存储空间量来控制的。在Cloudera Manager管理控制台中配置数据保留：1.转到Cloudera管理服务。2.单击 **配置** 选项卡。3.选择 **作用域>服务监视器或Cloudera管理服务（服务范围）**。 4.选择 **类别>主**。5.找到 **propertyName** 属性或通过在搜索框中输入名称来搜索它。**时间序列存储：** 用于存储时间序列和健康数据的大致磁盘空间量。当存储达到其最大尺寸时，它将删除较旧的数据以为更新的数据腾出空间。磁盘使用率是近似值，因为存储只有在达到限制时才开始删除数据。请注意，Cloudera Manager以多种不同的数据粒度存储时间序列数据，并且这些粒度具有不同的有效保留期。服务监视器不仅将度量数据存储为原始数据点，还将其存储为十分钟，每小时，每六小时，每日和每周的摘要数据点。原始数据占用大部分分配的存储空间，每周总结消耗最少。原始数据保留最短时间，而每周汇总点不可能被删除。请参阅Cloudera Manager中的 **Cloudera管理服务>图表库** 选项卡，了解有关在服务监视器中如何消耗空间的信息。这些预建图表还显示有关每个数据粒度所保留的数据量和时间窗口的信息。**Impala存储：** 大约专用于存储Impala查询数据的磁盘空间量。当存储达到其最大尺寸时，它会删除较旧的数据以为较新的查询腾出空间。磁盘使用率是近似值，因为存储只有在达到限制时才开始删除数据。**YARN存储：** 用于存储YARN应用程序数据的大致磁盘空间量。当存储达到最大尺寸时，它会删除较旧的数据以为新应用程序腾出空间。磁盘使用率是近似值，因为Cloudera Manager只有在达到限制时才开始删除数据。6.点击 **保存更改** 以提交更改。 |
| 规模，规划和最佳实践 | 服务监视器收集有关群集中配置的角色和服务的度量标准，并且还运行活动的运行状况测试。无论闲置和使用期限如何，这些健康测试都会运行，因为它们总是相关的。 服务监视器收集指标和运行状况测试结果，而不管集群中活动的级别如何。 即使在空闲的群集中，这些数据也在不断增长。 |

### 2.3.Cloudera管理服务 - 主机监视器

| 配置主题 | 服务监视器配置 |
| :------------- | :------------- |
| 默认存储位置 | **/var/lib/cloudera-host-monitor/** 在运行Host Monitor角色的主机上。 |
| 存储配置 **默认值/最小值/最大值** | 默认（和最小）：10GiB主机时间序列存储 |
| 何处控制数据保留或大小 | 主机监视器数据增长是通过配置它可以使用的最大存储空间量来控制的。请参阅监控数据的数据存储。要在Cloudera Manager管理控制台中配置这些数据保留配置属性，请执行以下操作：1.转到Cloudera管理服务。2.单击 **配置** 选项卡。3.选择 **Scope > 主机监视器或Cloudera管理服务(服务范围)**。4.选择 **类别>主**。5.找到每个属性或通过在“搜索”框中键入其名称来搜索它。6.**时间序列存储：** 用于存储时间序列和健康数据的大致磁盘空间量。当存储达到其最大尺寸时，它将删除较旧的数据以为较新的数据腾出空间。磁盘使用率是近似值，因为存储只有在达到限制时才开始删除数据。请注意，Cloudera Manager以多种不同的数据粒度存储时间序列数据，并且这些粒度具有不同的有效保留期。主机监视器不仅将度量数据存储为原始数据点，而且还将其作为10分钟，1小时，6小时，1天和1周增量的摘要。原始数据占用大部分分配的存储空间，每周总结消耗最少。原始数据保留最短时间，而每周汇总点不可能被删除。请参阅Cloudera Manager中的 **“Cloudera管理服务”>“图表库”** 选项卡，了解有关主机监视器中消耗空间的信息。这些预建的图表还显示有关保留的数据量和每个数据粒度覆盖的时间窗口的信息。6.点击 **保存更改** 以提交更改。 |
| 规模调整，规划和最佳实践 | 主机监视器收集有关主机级别项目的指标（例如：磁盘空间使用情况，RAM，CPU使用情况，交换等），并通知主机运行状况测试。 无论群集中的活动级别如何，主机监视器都会收集度量标准和运行状况测试结果。 即使在闲置的群集中，这些数据仍然保持线性增长。 |

### 2.4.Cloudera管理服务 - 事件服务器

| 配置主题 | 服务监视器配置 |
| :------------- | :------------- |
| 默认存储位置 | **/var/lib/cloudera-scm-eventserver/** 配置在事件服务器角色运行的主机上。 |
| 存储配置默认值 | 保留5,000,000个事件 |
| 何处控制数据保留或最小/最大值 | 事件服务器使用的存储空间量受配置它可以保留多少个离散事件的影响。要在Cloudera Manager管理控制台中配置数据保留。1.转到Cloudera管理服务。2.单击 **配置** 选项卡。3.选择 **Scope> Event Server或Cloudera Management Service（服务范围）**。4.选择 **类别>主**。5.编辑以下属性：**事件服务器存储中事件的最大数量：** 事件中事件服务器存储的最大大小。超过此大小时，事件将从最早的第一个开始删除，直到存储的大小低于此阈值。6.点击 **保存更改** 以提交更改。 |
| 规模，规划和最佳实践 | 事件服务器是一个管理的Lucene索引，用于收集集群内发生的相关事件，例如运行状况测试的结果，当日志条目与一组用于标识感兴趣的消息并使其可用于搜索的规则匹配时创建的日志事件 ，过滤和其他操作。您可以在Cloudera Manager管理控制台的 **诊断>事件** 选项卡上查看和过滤事件。您还可以使用Cloudera Manager API轮询此数据。**注意：Cloudera Management Service角色Alert Publisher通过定期轮询事件服务器以查找标记为使用SNMP或SMTP（S）发送的条目来获取其工作的所有内容。不讨论Alert Publisher，因为它没有自己的值得注意的存储要求。** |

### 2.5.Cloudera管理服务 - 报告管理器

| 配置主题 | 服务监视器配置 |
| :------------- | :------------- |
| 默认存储位置 | **RDBMS：** 任何支持的RDBMS。有关更多信息，请参阅CDH和Cloudera Manager支持的数据库。**磁盘：/var/lib/cloudera-scm-headlamp/** 在配置Reports Manager角色的主机上。 |
| 存储配置默认值 | **RDBMS：** 这里没有可配置的参数来直接控制这个数据集的大小。**磁盘：** 没有可配置的参数来直接控制该数据集的大小。存储利用率不仅取决于HDFS fsimage的大小，还取决于HDFS文件路径的复杂性。较长的文件路径有助于提高空间利用率。|
| 何处控制数据保留或最小/最大值 | 报告管理器在两个主要位置中使用空间：在报告管理器主机和其支持数据库上。Cloudera建议将数据库放置在与Reports Manager主机不同的主机上，以实现进程隔离和性能。|
| 规模，规划和最佳实践 | Reports Manager从NameNode下载fsimage（默认情况下每60分钟一次），并将其存储在本地以执行操作，包括索引HDFS文件系统结构。更多的文件和目录会导致更大的fsimage，从而消耗更多的磁盘空间。Reports Manager无法控制fsimage的大小。如果您的HDFS总使用量明显上升或者您在HDFS中添加了过长的路径，则可能需要重新访问并调整分配给Reports Manager的本地存储量。定期监控，检查和调整本地存储分配。|

## 3.Cloudera Navigator

### 3.1.Cloudera Navigator - 导航器审计服务器

| 配置主题 | Navigator Audit Server配置 |
| :------------- | :------------- |
| 默认存储位置 | 任何支持的RDBMS。有关更多信息，请参阅CDH和Cloudera Manager支持的数据库。 |
| 存储配置默认值 | 默认值：90天保留 |
| 何处控制数据保留或最小/最大 | Navigator Audit Server存储使用率通过配置可保留的数据天数来控制。任何较旧的数据都会被清除。要在Cloudera Manager Administration Console中配置数据保留：1.转到Cloudera管理服务。2.单击 **配置** 选项卡。3.选择 **范围>导航器审计服务器或Cloudera管理服务（服务范围）**。4.选择 **类别>主**。5.找到 **导航器审计服务器数据有效期限** 属性或通过在搜索框中键入其名称来搜索它。**Navigator Audit Server数据到期时间：** 在导航审计服务器中，当数据达到这个年龄时，清除各种可审计服务的审计数据。默认情况下，Navigator Audit Server会将有关审核的数据保留90天。6.点击 **保存更改** 以提交更改。|
| 规模，规划和最佳实践 | 导航器审计服务器数据库的大小直接取决于群集审计服务生成的审计事件的数量。正常情况下，HDFS审计量超过其他审计量（所有其他组件，如MRV1，Hive和Impala从HDFS中读取，这会产生额外的审计事件）。离散HDFS审计事件的平均大小为〜1KB。对于每小时生成约100K审计事件的50台主机的繁忙集群，Navigator Audit Server数据库每天将消耗约2.5GB。要在该级别保留90天的审计，请计划数据库大小为250GB左右。如果其他配置的集群服务生成的数据量与HDFS审核大致相同，则计划导航器审核服务器数据库在90天的数据中需要大约500GB的存储空间。**备注：1.单个Hive和Impala查询本身可能非常大。由于查询本身是审计事件的一部分，因此此类审计事件会占用与查询长度成比例的空间。2.随着群集上的活动增加，所需的空间量也会增加。在某些情况下，对于90天的审计事件，Navigator Audit Server数据库可能会超过1TB。定期对您的群集进行基准测试并相应地进。** 要将Cloudera Navigator版本映射到Cloudera Manager版本，请参阅Cloudera Navigator的产品兼容性矩阵。 |

### 3.2.Cloudera Navigator - 导航器元数据服务器

| 配置主题 | 导航器元数据服务器配置 |
| :------------- | :------------- |
| 默认存储位置 | **RDBMS：** 任何支持的RDBMS。有关更多信息，请参阅CDH和Cloudera Manager支持的数据库。**磁盘：** 在导航器元数据服务器角色配置的主机上的 **/var/lib/cloudera-scm-navigator/**。 |
| 存储配置默认值 | **RDBMS：** 没有公开的默认值或配置来直接筛选或清除此数据集的大小。**磁盘：** 没有配置默认值会影响此位置的大小。您可以使用 **导航器元数据服务器存储目录** 属性更改位置本身。此位置中的数据大小取决于系统中的元数据量（HDFS fsimage大小，Hive Metastore大小）和系统活动（运行MapReduce作业的数量，执行的Hive查询等）。 |
| 何处控制数据保留或最小/最大 | **RDBMS：** 应仔细调整Navigator Metadata Server数据库以支持大量的元数据。**磁盘：** Navigator Metadata Server索引（嵌入式Solr实例）可能会在为 **Navigator Metadata Server Storage Dir** 属性指定的位置消耗大量磁盘空间。正在进行的维护任务包括从系统中清除元数据。 |
| 规模，规划和最佳实践 | **内存：** 请参阅导航器元数据服务器调整。**RDBMS：** 数据库用于存储策略和授权数据。数据集很小，但是在Solr模式升级过程中也使用此数据库，其中Solr文档被提取并再次插入到Solr中。这与上述用例具有相同的空间要求，但该空间仅在产品升级期间暂时使用。使用Cloudera Navigator产品兼容性矩阵的产品兼容性矩阵来映射Cloudera Navigator和Cloudera Manager版本。**磁盘：** 此文件系统位置包含从托管集群中提取的所有元数据。数据存储在Solr中，因此这是Solr存储其索引和文档的位置。根据群集的大小，此数据可能占用数十GB。一个指导方针是查看HDFS fsimage的大小，并将其大小分配为初始大小的两到三倍。这里的数据是增量式的，并且随着在群集上执行活动而不断增加。增长速度可能是每天几十兆字节。|

**一般性能说明**：

如果可能：
+ 对于使用RDBMS的实体，将数据库安装在与服务不同的主机上，并在尽可能少的服务器上合并使用数据库的角色。
+ 为RDBMS或数据存储数据目录提供专用主轴，以避免与其他读/写活动的磁盘争用。

## 4. 使用Cloudera Manager进行集群生命周期管理
使用parcels提供CDH和其他组件的Cloudera Manager群集在以下位置需要足够的磁盘空间：

### 4.1.Parcel生命周期管理

| Parcel生命周期路径（默认） | 备注 |
| :------------- | :------------- |
| 本地Parcel存储库路径（/opt /cloudera/parcel-repo） | 此路径仅存在于运行Cloudera Manager Server（cloudera-scm-server）的主机上。Cloudera Manager Server会在此位置对所有新parcel进行分段，因为它从任何外部存储库中获取它们。然后，当管理员使用Cloudera Manager Administration Console或Cloudera Manager API分发parcel时，Cloudera Manager Agents将被指示从此位置获取parcel。**规模和规划：** 默认位置为 /opt/cloudera/parcel-repo，但您可以在运行Cloudera Manager Server的主机上配置其他本地文件系统位置。请参阅Parcel配置设置。提供足够的空间来容纳从所有配置的远程Parcel资料库URL下载的所有Parcel（请参Parcel地配置设置）。管理多个群集的Cloudera Manager部署存储所有群集的所有适用Parcel。为每个操作系统提供包，因此请注意，与具有同类操作系统的群集相比，异构群集（集群中表示的不同操作系统）需要更多的空间。例如，具有RHEL6.x和7.x主机的群集必须在Local Parcel Repository Path中保存-el6和-el7 parcel，这需要两倍的空间量。**生命周期管理和最佳实践：** 从Cloudera Manager管理控制台中删除任何不再使用的Parcel（从不从命令行手动删除它们），以恢复本地Parcel存储库路径中的磁盘空间，同时跨所有包含该Parcel的托管群集主机。**备份注意事项：** 定期备份此路径，并将其视为备份Cloudera Manager Server的非可选附件。如果将Cloudera Manager Server迁移到新主机或从备份中恢复（例如，硬件故障后），请在 /opt /cloudera/parcel-repo 目录中将此路径的完整内容恢复到新主机 启动任何cloudera-scm-agent或cloudera-scm-server进程。|
| Parcel缓存（/opt/cloudera/parcel-cache）| 运行Cloudera Manager Agent阶段的托管主机将分发parcels分发到此路径中（如.parcel文件，未提取）。不要手动操作此目录或其文件。**规模和规划：** 为每个主机提供足够的空间来容纳分发给每个主机的所有parcels。您可以将Cloudera Manager配置为在将这些缓存的.parcel文件解压并放置在/opt/ cloudera/parcels/ 中后删除这些文件。保留这些临时文件并不是强制性的，但如果您出于任何原因需要再次提取parcels，则保留它们可以避免从Cloudera Manager Server存储库传输.parcel文件。要在Cloudera Manager管理控制台中配置此行为，请选择 **管理>设置>Parcels>保留下载的Parcels文件**。 |
| 主机Parcels目录（/opt/cloudera/parcels）| 运行Cloudera Manager Agent的受管群集主机在parcel激活时将parcel从 /opt/cloudera/parcel-cache 目录中提取到此路径中。许多关键系统符号链接指向此路径中的文件，您绝不应手动操作其内容。**规模和规划：** 在每台主机上提供足够的空间来容纳分发给每台主机的所有Parcels。请注意，典型的CDH parcels大小约为每个parcels 2GB，并且某些第三方parcels可能超过3GB。如果您在升级前后维护各种版本的parcels，请注意磁盘空间的影响。您可以将Cloudera Manager配置为在较旧的parcels不再使用时自动删除它们。作为管理员，您始终可以手动删除未使用的parcels版本，但配置这些设置可以自动处理删除，以防忘记。要在Cloudera Manager Administration Console中配置此行为，请选择 **管理>设置>parcels** 并配置以下属性：**自动删除旧parcels：** 此参数控制是否应在群集不再使用时从群集中删除旧版本激活产品的parcels。默认值是Disabled。**要保留的旧parcels版本数：** 如果启用自动删除旧parcels，则此设置指定要保留的旧parcels的数量。任何超出此值的旧parcels都将被删除。 如果此属性设置为零，则不会保留旧parcels。默认值是3。 |

### 4.2.管理服务生命周期 - 空间回收任务

| 任务 | 描述 |
| :------------- | :------------- |
| 活动监视器（一次性） | 活动监视器仅适用于MapReduce（MR1）服务，而不是YARN。因此，如果您的部署已完全迁移到YARN并不再使用MapReduce（MR1）服务，则您的活动监视器数据库不再增长。如果您等待的时间超过默认Activity Monitor保留期限（14天）以解决这一问题，则活动监视器已经为您清除了所有内容，并且您的数据库大部分都是空的。如果您的部署满足这些条件，请考虑通过删除活动监视器数据库（再次，只有当您确信不再需要数据或已确认不再使用数据时）和活动监视器角色来清理。|
| 服务监视器和主机监视器（一次性） | 对于那些使用Cloudera Manager 4.x版并且现在已升级到版本5.x的用户：服务监视器和主机监视器已从先前配置的RDBMS迁移到专用的时间序列存储，这些存储分别仅由这些角色中的每个角色使用。发生这种情况后，这些角色的配置中仍存在传统数据库连接信息。这用于允许初始迁移，但不再用于任何活动工作。上述迁移发生后，不再使用以前由服务监视器和主机监视器使用的RDBMS数据库。这些数据库占用的空间现在可以恢复。如果适合您的环境（并且您对长期备份感到满意或者不再需要磁盘上的数据），则可以删除这些数据库。|
| 正在进行的空间回收 | Cloudera Management Services会在后台自动汇总，清除或整合老化数据。配置每个角色的保留和清除限制，以控制发生这种情况的方式和时间。这些配置将在上面的每个实体中讨论。调整默认配置以满足您的空间限制或保留需求。 |

### 4.3.日志文件
所有CDH群集主机都会为分配给主机的每个角色实例写出单独的日志文件。群集管理员可以监视和管理这些角色使用的
磁盘空间，并配置日志轮转以防止日志文件占用过多的磁盘空间。

有关更多信息，请参阅管理日志文件的磁盘空间。

### 4.4.结论
记住这些信息，以便规划和构建由Cloudera Manager管理的群集的部署。如果您已有活动群集，则此生命周期和备
份信息可帮助您保持关键监视，审核和元数据源的安全并正确备份。
