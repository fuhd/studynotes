表之对日期列进行高效分区
===================================================================================
**日期型经常是分区键最常用的候选对象**。要采用日期来对数据进行分区的用例有很多。最常见的一
个例子就是，如果你正在将各种日志文件加载到HDFS中并且希望使用Hive来查询它们，那么你很可能希望
按天来组织数据。**当按照日期来创建分区时，按“YYYY-MM-DD”格式的单个字符串进行分区，总是比使用
年、月、日各自的值进行多深度分区更加高效。使用单个字符串的优势在于，它允许使用更多的SQL运算
符，例如`LIKE`、`IN`和`BETWEEM`，但是如果你采用嵌套分区，就不太容易使用这些运算符了**。

假设我们有表A，通过DateStamp字符串按照“YYYY-MM-DD”格式进行分区。可以使用查询 **选择特定日期**：
```sql
SELECT * FROM TableA WHERE DateStamp IN ('2015-01-01','2015-02-03','2016-01-01');
```
**查询一年中所有的日期**：
```sql
SELECT * FROM TableA WHERE DateStamp LIKE '2015-%';
```
**查询一年中特定月的所有日期**：
```sql
SELECT * FROM TableA WHERE DateStamp LIKE '2015-02-%';
```
**查询所有以5开始/结束的日子**：
```sql
SELECT * FROM TableA WHERE DateStamp LIKE '%-%-%5';
```
**查询2015年1月1日到2015年3月1日的所有日子**：
```sql
SELECT * FROM TableA WHERE DataStamp BETWEEN '2015-01-01' AND '2015-03-01';
```

## 分桶
**Hive中的分桶是另一种将数据切分为更小片段的方式**。到目前为止，我们已经知道分区如何帮助我们更
高效地组织和访问数据。然而，**高效的分区要求采用分区键，且不会导致出现大量非常小的分区**。因此，
**如果你的分区键有很多不同的值，且分区键的每个值都没有多少行，那么分区并不是最佳选择**。

分桶很适合用于上述情形。**分桶让你可以为每个表的分桶列定义桶的最大数目**。Hive中的一个分区就是
一个目录，分区键的值存放在实际的分区目录名中，而分区键是表中的一个虚拟列。**然而在分桶中，每个桶都
是一个保存实际数据的文件，这些数据基于一种散列算法进行分割。分桶并不会为当前表添加一个虚拟列**。

和分区一样，**分桶有其自身的优势，最主要的一点就是能够提升多种查询的性能。如果分桶所用的键是非倾斜的，
那么你的数据将会均衡分布**。这一点可以用于实现高效的数据抽样。

下面是一个创建表并且进行分桶的例子。我们创建了一个customers表，并且 **将创建的custid列作为一个分桶
列。将其分割成了11个桶**：
```sql
CREATE EXTERNAL TABLE shopping.customers3 (
	custid			INT,
	fname 			STRING,
	lname			STRING, 
	city 			STRING,
	state 			STRING 
)
CLUSTERED BY (custid) INTO 11 BUCKETS 
LOCATION '/user/hive/customers3';
```
现在，当你向该表中插入数据时，Hive将custid用于散列函数，将数据分发到11个桶当中。对于有些数据类型
来说，这就意味着那些含有相同custid值的行将被存放在相同的桶中。
```
警告

要设置 hive.enforce.bucketing=True。没有这个参数，你就需要为表定义与桶的数量相同的映射器。
```