准备环境
================================================================================
要使用Ambari部署Hortonworks堆栈，您需要准备部署环境：
+ 设置无密码SSH
+ 设置服务用户帐户
+ 在群集和浏览器主机上启用NTP
+ 检查DNS和NSCD
+ 配置iptables
+ 禁用SELinux和PackageKit并检查umask值
+ 下载并设置数据库连接器
+ 为Ranger配置数据库实例
+ 安装HDF服务的数据库

## 1.设置无密码SSH

### 1.1.关于这个任务
要让`Ambari Server`在所有群集主机上自动安装`Ambari Agent`，必须在`Ambari Server`主机与群
集中的所有其他主机之间设置无密码SSH连接。`Ambari Server`主机使用SSH公钥身份验证来远程访问和安
装Ambari代理。
```
提示

您可以选择在每个群集主机上手动安装Ambari代理。在这种情况下，您不需要生成和分发SSH密钥。
```

### 1.2.步骤
1. 在`Ambari Server`主机上生成公钥和私钥SSH密钥。
    ```shell
    ssh-keygen
    ```
2. 将SSH公钥（`id_rsa.pub`）复制到目标主机上的root帐户。
    ```shell
    .ssh/id_rsa
    .ssh/id_rsa.pub
    ```
3. 将SSH公钥添加到目标主机上的`authorized_keys`文件中。
    ```shell
    cat id_rsa.pub >> authorized_keys
    ```
4. 根据您的SSH版本，您可能需要在目标主机上的`.ssh`目录（至700）和该目录（至600）中的
`authorized_keys`文件上设置权限。
    ```shell
    chmod 700 ~/.ssh
    chmod 600 ~/.ssh/authorized_keys
    ```
5. 从`Ambari Server`，确保您可以使用SSH连接到群集中的每个主机，而无需输入密码。
    ```shell
    ssh root@<remote.target.host>
    ```
    其中`<remote.target.host>`具有集群中每个主机名的值。
6. 如果在第一次连接期间显示以下警告消息：您确定要继续连接（是/否）吗？输入 **是**。
7. 在运行基于Web的Ambari安装向导的计算机上保留SSH私钥的副本。
    ```
    提示

    如果该帐户可以在不输入密码的情况下执行sudo，则可以使用非root SSH帐户。
    ```

## 2.设置服务用户帐户
**每项服务都需要一个服务用户帐户**。Ambari群集安装向导会创建新的并保留所有现有服务用户帐户，并
在配置Hadoop服务时使用这些帐户。服务用户帐户创建适用于本地操作系统和`LDAP/AD`帐户上的服务用户
帐户。

## 3.在群集和浏览器主机上启用NTP
**群集中所有节点的时钟和运行访问`Ambari Web`界面的浏览器的计算机必须能够相互同步**。要安装NTP
服务并确保它在启动时启动，在 **每台主机** 上运行以下命令：
```shell
#RHEL/CentOS/Oracle 7
yum install -y ntp
systemctl enable ntpd
```

## 4.检查DNS和NSCD
必须为系统中的所有主机配置正向和反向DNS。

如果您无法以这种方式配置DNS，则应编辑群集中每个主机上的 **/etc/hosts** 文件，以包含每个主机的
IP地址和完全限定域名。以下说明作为概述提供，涵盖了通用Linux主机的基本网络设置。Linux的不同版本
和风格可能需要稍微不同的命令和过程。请参阅环境中部署的操作系统的文档。

**Hadoop严重依赖DNS**，因此在正常操作期间执行许多DNS查找。为减少DNS基础结构的负载，强烈建议在
运行Linux的群集节点上使用 **名称服务缓存守护程序（NSCD）**。该守护进程将缓存主机，用户和组查找，
并提供更好的解决方案性能，并减少DNS基础结构的负载。

### 4.1.编辑hosts文件
1. 使用文本编辑器，在群集中的 **每个主机** 上打开hosts文件。例如：
    ```shell
    vi /etc/hosts
    ```
2. 为群集中的每个主机添加一行。该行应包含 **IP地址和FQDN**。例如：
    ```ini
    1.2.3.4  <fully.qualified.domain.name>
    ```
    ```
    重要

    不要从hosts文件中删除以下两行。 删除或编辑以下行可能会导致需要网络功能的各种程序失败。

    127.0.0.1 localhost.localdomain localhost
    ::1 localhost6.localdomain6 localhost6
    ```

### 4.2.设置主机名（hostname）
1. 通过运行以下命令确认已设置主机名：
    ```shell
    hostname -f
    ```
    这应该返回你刚刚设置的 **<fully.qualified.domain.name>**。
2. 使用“hostname”命令在集群中的每个主机上设置主机名。例如：
    ```shell
    hostname <fully.qualified.domain.name>
    ```

### 4.3.编辑网络配置文件
1. 使用文本编辑器，在 **每个主机** 上打开网络配置文件，并为每个主机设置所需的网络配置。例如：
    ```shell
    vi /etc/sysconfig/network
    ```
2. 修改 **HOSTNAME属性** 以设置完全限定的域名。
    ```ini
    NETWORKING=yes
    HOSTNAME=<fully.qualified.domain.name>
    ```

## 5.配置iptables
为使Ambari在安装期间与其部署和管理的主机进行通信，**某些端口必须是开放且可用的**。最简单的方法
是 **暂时禁用iptables**，如下所示：

### 5.1.RHEL/CentOS/Oracle/Amazon Linux
```shell
systemctl disable firewalld
service firewalld stop
```
安装完成后，您可以重新启动iptables。如果您环境中的安全协议阻止禁用iptables，则可以启用iptables，
如果所有必需的端口都已打开且可用。

Ambari会在`Ambari Server`安装过程中检查iptables是否正在运行。如果iptables正在运行，则会显
示警告，提醒您检查所需端口是否已打开且可用。群集安装向导中的“主机确认”步骤还会为运行iptables的
每个主机发出警告。

## 6.禁用SELinux和PackageKit并检查umask值
1. 您必须在集群中的 **每台主机** 上禁用SELinux才能使Ambari设置正常运行。输入：
    ```shell
    setenforce 0
    ```
    ```
    提示

    要在 /etc/selinux/config 中永久禁用SELinux，设置 SELINUX=disabled 可确保在重新启动计算机后SELinux不会自动打开。
    ```
2. 在运行安装了PackageKit的 **RHEL/CentOS** 的主机上，使用文本编辑器打开
`/etc/yum/pluginconf.d/refresh-packagekit.conf`。 变更：
    ```shell
    enabled=0
    ```
    ```
    提示

    默认情况下，在Debian，SLES或Ubuntu系统上未启用PackageKit。除非您专门启用了PackageKit，否则可以跳过Debian，SLES或
    Ubuntu安装主机的此步骤。
    ```
3. **UMASK（用户掩码或用户文件创建MASK）设置在Linux计算机上创建新文件或文件夹时授予的默认权限
或基本权限**。大多数Linux发行版将`022`设置为默认的umask值。umask值为`022`，为新文件或文件夹
授予`755`的读取，写入和执行权限。umask值`027`为新文件或文件夹授予`750`读取，写入和执行权限。
Ambari，HDP和HDF支持umask值`022`（`0022`在功能上等效），`027`（`0027`在功能上等效）。必须
在所有主机上设置这些值。
    ```
    UMARK

    1.权限掩码umask
    umask是chmod配套的，总共为4位（gid/uid,属主，组权，其它用户的权限），不过通常用到的是后3个，例如你用chmod 755 file
    （此时这文件的权限是属主读(4)+写(2)+执行(1)，同组的和其它用户有读写权限）。

    2.umask的作用
    默认情况下的umask值是022(可以用umask命令查看），此时你建立的文件默认权限是644(6-0,6-2,6-2)，建立的目录的默认权限是
    755(7-0,7-2,7-2)，可以用ls -l验证一下。
    ```
    UMASK示例：

    为当前登录会话设置umask：
    ```shell
    umask 0022
    ```
    检查您当前的umask：
    ```shell
    umask
    ```
    永久更改所有交互式用户的umask：
    ```shell
    echo umask 0022 >> /etc/profile
    ```

## 7.下载并设置数据库连接器
像Druid，Hive，Ranger，Oozie和Superset这样的组件需要一个可操作的数据库。在安装过程中，您可
以选择使用现有数据库，或者在Hive的情况下让Ambari安装新实例。要使Ambari连接到您选择的数据库，
必须在安装组件之前直接从数据库供应商下载必要的 **数据库驱动程序和连接器**。要更好地为安装或升级
做好准备，**请在设置环境时设置数据库连接器**。

### 7.1.为Ranger配置数据库实例
MySQL，Oracle，PostgreSQL或Amazon RDS数据库实例必须正在运行并且可供Ranger使用。**Ranger安
装将创建两个新用户（默认名称：rangeradmin和rangerlogger）和两个新数据库（默认名称：ranger和
ranger_audit）**。
```
下面我们只以mysql为例
```

#### 7.1.1.为Ranger配置MySQL

##### **先决条件**
使用MySQL时，用于Ranger管理策略存储表的 **存储引擎必须支持事务**。InnoDB是支持事务的引擎示例。
不支持事务的存储引擎不适合作为策略存储。

##### **步骤**
1. 应使用MySQL数据库管理员权限创建Ranger数据库。

以下一系列命令可用于创建密码为 rangerdba的rangerdba用户。
  - 以root用户身份登录，然后使用以下命令创建rangerdba用户并授予其足够的权限。
    ```sql
    CREATE USER 'rangerdba'@'localhost' IDENTIFIED BY 'rangerdba';
    GRANT ALL PRIVILEGES ON *.* TO 'rangerdba'@'localhost';
    CREATE USER 'rangerdba'@'%' IDENTIFIED BY 'rangerdba';
    GRANT ALL PRIVILEGES ON *.* TO 'rangerdba'@'%';
    GRANT ALL PRIVILEGES ON *.* TO 'rangerdba'@'localhost' WITH GRANT OPTION;
    GRANT ALL PRIVILEGES ON *.* TO 'rangerdba'@'%' WITH GRANT OPTION;
    FLUSH PRIVILEGES;
    ```
  - 使用exit命令退出MySQL。
  - 您现在应该能够使用以下命令以rangerdba重新连接到数据库：
      ```shell
      mysql -u rangerdba -prangerdba
      ```
      测试rangerdba登录后，使用exit命令退出MySQL。

2. 使用以下命令确认`mysql-connector-java.jar`文件位于Java共享目录中。必须在安装Ambari服务
器的服务器上运行此命令。
    ```shell
    ls /usr/share/java/mysql-connector-java.jar
    ```
    如果该文件不在Java共享目录中，请使用以下命令安装MySQL连接器`.jar`文件。

    **RHEL/CentOS/Oracle/Aamazon Linux**
    ```shell
    yum install mysql-connector-java*
    ```
3. 使用以下命令格式根据MySQL JDBC驱动程序`.jar`文件的位置设置jdbc/driver/path。此命令必须
在安装Ambari服务器的服务器上运行。
    ```shell
    ambari-server setup --jdbc-db={database-type} --jdbc-driver={/jdbc/driver/path}
    ```
    示例：
    ```shell
    ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar
    ```

### 7.2.安装HDF服务的数据库
安装`Schema Registry`，`SAM`，`Druid`和`Superset`时，需要一个关系数据存储来 **存储元数据**。
您可以使用`MySQL`，`Postgres`，`Oracle`或`MariaDB`。这些主题描述了如何 安装MySQL，Postgres
和Oracle以及如何为其 **创建数据库SAM和Schema Registry**。如果使用Superset在现有HDP群集上进行安装，
则可以跳过安装说明，因为MySQL是使用Druid安装的。在这种情况下，请配置数据库。
```
提示

你应该安装Postgres，Oracle或MySQL；建议您使用MySQL。
```
```
警告

如果要安装Postgres，则必须为SAM和Schema Registry安装Postgres 9.5或更高版本。Ambari不安装Postgres 9.5，因此您必须
手动执行Postgres安装。
```

#### 7.2.1.安装和配置MySQL
+ 关于这个任务
您可以安装MySQL 5.5或更高版本。
+ 在你开始之前
在Ambari主机上，安装MySQL的JDBC驱动程序，然后将其添加到Ambari：
    ```shell
    yum install mysql-connector-java*
    sudo ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar
    ```
+ 步骤
    1. 登录到要安装`MySQL Metastore`的节点，以用于SAM，`Schema Registry`和Druid。
    2. 安装`MySQL community server`，并启动MySQL服务：
        ```shell
        yum localinstall https://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm
        yum install mysql-community-server
        systemctl start mysqld.service
        ```
    3. 获取随机生成的MySQL root密码。
        ```shell
        grep 'A temporary password is generated for root@localhost' /var/log/mysqld.log |tail -1
        ```
    4. 重置MySQL root密码。输入以下命令。系统将提示您输入在上一步中获得的密码。然后，MySQL会
    要求您更改密码。
        ```shell
        /usr/bin/mysql_secure_installation
        ```

#### 7.2.2.在MySQL中配置SAM和Schema Registry元数据存储
**步骤**
1. 启动MySQL监视器：
    ```shell
    mysql -u root -p
    ```
2. 为Schema Registry和SAM Metastore创建数据库：
    ```sql
    create database registry;
    create database streamline;
    ```
3. 创建`Schema Registry`和SAM用户帐户，替换最终的`IDENTIFIED BY`密码字符串：
    ```sql
    CREATE USER 'registry'@'%' IDENTIFIED BY 'R12$%34qw';
    CREATE USER 'streamline'@'%' IDENTIFIED BY 'R12$%34qw';
    ```
4. 为用户帐户分配权限：
    ```sql
    GRANT ALL PRIVILEGES ON registry.* TO 'registry'@'%' WITH GRANT OPTION ;
    GRANT ALL PRIVILEGES ON streamline.* TO 'streamline'@'%' WITH GRANT OPTION ;
    ```
5. 提交操作：
    ```sql
    commit;
    ```
















































ddd
