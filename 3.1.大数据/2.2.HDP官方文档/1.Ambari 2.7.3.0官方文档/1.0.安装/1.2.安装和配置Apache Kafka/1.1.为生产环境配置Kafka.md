为生产环境配置Kafka
================================================================================
本章介绍与Kafka配置相关的主题，包括：
+ 准备环境
+ 为brokers、producers和consumers定制设置
+ 配置ZooKeeper与Kafka一起使用
+ 在安全集群上运行Kafka时启用对HDFS的审核

## 1.准备环境
以下因素可能会影响Kafka的表现：
+ 操作系统设置
+ 文件系统选择
+ 磁盘驱动器配置
+ Java版本
+ 以太网带宽

## 2.操作系统设置
配置Kafka时请考虑以下事项：
+ Kafka使用页面缓存内存作为活动编写器和读取器的缓冲区，因此在指定JVM大小（使用`-Xmx`和`-Xms`
Java选项）后，将剩余的RAM保留给操作系统以进行页面缓存。
+ Kafka需要打开文件和网络连接的文件描述符。您应该将文件描述符限制设置为 **至少128000**。
+ 您可以增加最大套接字缓冲区大小以启用高性能数据传输。

## 3.文件系统选择
Kafka使用常规的Linux磁盘文件进行存储。我们建议使用 **EXT4** 或 **XFS** 文件系统。对XFS文件
系统的改进表明Kafka工作负载的性能特性得到改善，而且不会影响稳定性。
```
警告：
1.由于存在索引失败的风险和（在网络文件系统的情况下）与使用MemoryMapped文件存储偏移索引相关的问题，请不要将已安装的共享驱
动器或任何网络文件系统与Kafka一起使用。
2.Kafka不支持加密文件系统，如SafenetFS。可能会发生索引文件损坏。
```

## 4.磁盘驱动器配置
对于吞吐量，我们建议将多个驱动器专用于Kafka数据。使用Kafka的驱动器通常比使用更少的驱动器更好。
不要将这些Kafka驱动器与任何其他应用程序共享或将它们用于Kafka应用程序日志。

您可以通过在`server.properties`文件中为`log.dirs`属性指定逗号分隔的目录列表来配置多个驱动器。
Kafka使用循环方法将分区分配给`log.dirs`中指定的目录；默认值为`/tmp/kafka-logs`。

`num.io.threads`属性应设置为等于或大于专用于Kafka的磁盘数的值。建议：**首先将此属性设置为等于
磁盘数**。

根据您配置刷新行为的方式（请参阅“日志刷新管理”），如果将`log.flush.interval.messages`属性设
置为在每`100,000`条消息（大约）之后刷新日志文件，**则更快的磁盘驱动器是有益的**。

当数据访问负载在分区之间平衡时，Kafka表现最佳，从而导致磁盘驱动器之间的平衡负载。此外，跨磁盘的
数据分发很重要。如果一个磁盘已满并且其他磁盘具有可用空间，则可能会导致性能问题。为避免Kafka服务
减速或中断，您应创建使用警报，以便在可用磁盘空间不足时通知您。

`RAID`可以潜在地改善磁盘之间的负载平衡，但RAID可能会因写入速度较慢而导致性能瓶颈。此外，它还减
少了可用磁盘空间。虽然`RAID`可以容忍磁盘故障，但重建RAID阵列是`I/O`密集型的，并且可以有效地禁
用服务器。因此，`RAID`不能提供可用性的实质性改进。

## 5.Java版本
使用`HDP 2.5`上的`Apache Kafka`，您应该使用Java版本`1.8`的最新更新，并确保启用`G1`垃圾回收
支持。（**默认情况下，在最新版本的Java中启用G1支持**。）如果您更喜欢使用`Java 1.7`，请确保使
用更新u51或更高版本。

以下是JVM的几个推荐设置：
```java
-Xmx6g
-Xms6g
-XX:MetaspaceSize=96m
-XX:+UseG1GC
-XX:MaxGCPauseMillis=20
-XX:InitiatingHeapOccupancyPercent=35
-XX:G1HeapRegionSize=16M
-XX:MinMetaspaceFreeRatio=50
-XX:MaxMetaspaceFreeRatio=80
```
要为Kafka broker设置JVM堆大小，请`export KAFKA_HEAP_OPTS`。例如：
```shell
export KAFKA_HEAP_OPTS="-Xmx2g -Xms2g"
./kafka-server-start.sh
```

## 6.以太网带宽
以太网带宽会对Kafka性能产生影响; 确保它足以满足您的吞吐量要求。
