升级到HDP-3.0+时迁移Atlas元数据
================================================================================
升级到HDP-3.0及更高版本时，必须执行其他步骤将Atlas元数据从Titan迁移到JanusGraph。

## 概览
在`HDP-3.0+`中，`Apache Atlas`使用 **JanusGraph图数据库** 来存储元数据对象。在早期版本中，
Atlas使用 **Titan图数据库** 进行元数据存储。升级到HDP-3.0及更高版本时，必须使用命令行迁移工具
将Atlas元数据从Titan迁移到JanusGraph。
1. 估计现有Atlas存储库的大小以及将元数据从`HDP 2.x` Titan数据库导出到`HDP 3.x` JanusGraph
数据库所需的时间。
2. 使用Atlas元数据迁移工具从`HDP 2.x`导出Atlas元数据。
3. 将Atlas元数据导入`HDP 3.x`。

## 升级到HDP-3.0+ 时迁移Atlas元数据
从`HDP-2.x`升级到`HDP-3.0`及更高版本时，执行以下步骤将Atlas元数据从Titan迁移到JanusGraph。

### 1.过程
1. 在升级HDP和Atlas之前，请使用以下方法之一来确定`HDP-2.x`群集上Atlas元数据的大小。
    + 单击`Atlas Web UI`上的SEARCH，然后将绿色切换按钮从 **Basic** 切换到 **Advanced**。
    在“按查询搜索”框中输入以下查询，然后单击“搜索”。
      ```
      Asset select count()
      ```
    + 运行以下Atlas指标REST API查询：
      ```
      curl -g -X GET -u admin:admin -H "Content-Type: application/json" -H "Cache-Control: no-cache" "http://<atlas_server>:21000/api/atlas/admin/metrics"
      ```
    这两种方法中的任何一种都返回Atlas实体的数量，这些实体可用于估计从`HDP-2.x`导出Atlas元数据
    并将其导入`HDP-3.x`所需的时间。此时间取决于群集配置。以下估计适用于具有4GB RAM四核处理器
    且同一节点上同时具有Atlas和Solr服务器的节点：
    + 从`HDP-2.x`出口的估计持续时间：每小时200万个实体。
    + 导入`HDP-3.x`的预计持续时间：每小时0.75百万个实体。
2. 在升级HDP和Atlas之前，请在`HDP-2.x`群集上执行以下步骤。
    1. 按照Ambari升级指南中的“注册和安装目标版本”中的说明注册HDP目标版本。不安装目标版本 - 仅
    执行注册目标版本的步骤。这将下载`HDP-3.0`文件。
    2. 在Ambari仪表板上，单击Atlas，然后选择“操作”>“停止”。
    3. 使用`HDP-3.0`导出器工具运行导出。通常，该工具位于`/usr/hdp/3.0.0.0-<build_number>/atlas/tools/migration-exporter`。
    使用以下命令格式开始导出Atlas元数据：
        ```shell
        python /usr/hdp/3.0.0.0-<build_number>/atlas/tools/migration-exporter/atlas_migration.py -d <output directory>
        ```
        运行时，Atlas迁移工具可防止Atlas使用，并阻止所有REST API和Atlas挂钩通知处理。
        如前所述，导出Atlas元数据所需的时间取决于实体数量和群集配置。您可以使用以下命令显示导
        出状态：
        ```shell
        tail -f /var/log/atlas/atlas-migration-exporter.log
        ```
        导出完成后，数据将放在指定的输出目录中。
    4. 在Ambari仪表板上，选择`Atlas>Configs>Advanced>Custom application-properties`。
    单击“添加属性”，然后添加`atlas.migration.data.filename`属性并将其值设置为指向导出`HDP-2.x`
    数据时指定的输出文件夹中`atlas-migrationdata.json`文件的完整路径。
3. 升级HDP和Atlas。
4. 升级自动启动Atlas，启动将上载的`HDP-2.x` Atlas元数据迁移到`HDP-3.x`。在迁移导入过程中，
Atlas会阻止所有`REST API`调用和Atlas挂钩通知处理。
    您可以使用以下Atlas API URL显示迁移状态：
    ```
    http://<atlas_server>:21000/api/atlas/admin/status
    ```
    迁移状态显示在浏览器窗口中：
    ```
    {"Status":"Migration","currentIndex":139,"percent":67,"startTimeUTC":"2018-04-06T00:54"}
    ```
5. 迁移完成后，选择`Atlas>Configs>Advanced>Custom application-properties`，然后单击红
色的Remove按钮以删除`atlas.migration.data.filename`属性。
