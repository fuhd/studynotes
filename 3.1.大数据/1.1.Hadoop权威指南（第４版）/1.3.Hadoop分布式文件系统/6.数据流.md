数据流
==================================================================================
为了了解客户端及与之交互的HDFS、namenode和datanode之间的数据流是什么样的，我们可以 参考下图，
该图显示了在读取文件时事件的发生顺序。

客户端通过调用 *FileSystem* 对象的 *open()* 方法来打开希望读取的文件，对于HDFS来说，这个对
象是：*DistributedFileSystem* 的一个实例（**步骤1**）。*DistributedFileSystem* 通过使
用远程过程调用（*RPC*）来调用 *namenode*，以确定文件起始块的位置（**步骤2**）。对于每一个块，
*namenode* 返回存在该块副本的 *datanode* 地址。此外，这些 *datanode* 根据它们与客户端的距
离来排序（**根据集群的网络拓扑**）。如果该客户端本身就是一个 *datanode*（比如，在一个
*MapReduce* 任务中），那么该客户端将会从保存有相应数据块复本的本地 *datanode* 读取数据。

![客户端读取HDFS中的数据](img/1.jpeg)

*DistributedFileSystem* 类返回一个 *FSDataInputStream* 对象（一个支持文件定位的输入流）
给客户端以便读取数据。*FSDataInputStream* 类转而封装 *DFSInputStream* 对象，该对象管理着
*datanode* 和 *namenode* 的`I/O`。

接着，客户端对这个输入流调用 *read()* 方法（**步骤3**）。存储着文件起始几个块的 *datanode*
地址的 *DFSInputStream* 随即连接距离最近的文件中第一个块所在的 *datanode*。通过对数据流反复
调用 *read()* 方法，可以将数据从 *datanode* 传输到客户端（**步骤4**）。到达块的末端时，
*DFSInputStream* 关闭与该 *datanode* 的连接，然后寻找下一个块的最佳 *datanode*（**步骤5**）。
所有这些对于客户端都是透明的，在客户看来它一直在读取一个连续的流。

客户端从流中读取数据时，块是按照打开 *DFSInputStream* 与 *datanode* 新建连接的顺序读取的。
它也会根据需要询问 *namenode* 来检索下一批数据块的 *datanode* 的位置。一旦客户端完成读取，就
对 *FSDataInputStream* 调用 *close()* 方法（**步骤6**）。



































dd
