安装与配置Spark集群
================================================================================
## 1.下载Spark安装包
本书将使用Spark官方编译好的软件包进行安装。**在少数情况下，才会自行编译Spark源码或在编译之前根
据具体业务修改部分源码**。
+ 进入版本选择页面后，选择2.3.1版本，并单击“spark-2.3.1-bin-hadoop2.7.tgz”链接。
+ 将下载好的Spark压缩包上传至第1台虚拟机的“home/admin/softwares/installations”目录下。

## 2.检查与准备集群环境 

### 2.1.虚拟机的配置项
下表列出了三台虚拟机的核心配置项：
> 三台虚拟机的系统均为CentOS6.8版本，其与CentOS7.x系列版本的使用方式大同小异。

| 配置项 | linux01 | linux02 | linux03 |
|:------|:--------|:--------|:--------|
| 内存 | 4GB | 2GB | 2GB |
| CPU内核数 | 2 | 1 | 1 |
| 硬盘 | 50GB（单分区）| 50GB（单分区）|50GB（单分区）|
| 网络适配器 | NAT | NAT | NAT |

### 2.2.配置虚拟机系统
在部署Spark集群之前，需要确保三台虚拟机的软件环境一致的。

#### 2.2.1.禁用SELinux
分布式框架在进行端口通信时，**SELinux有可能阻塞其中的通信，因此暂且将其禁用**。在CentOS6.8中，
使用如下命令编辑SELinux配置文件：
```shell
vi /etc/sysconfig/selinux00000
```
并将SELINUX选项改为：
```ini
SELINUX:disable
```

#### 2.2.2.关闭防火墙
防火墙也可以导致分布式框架之间的通信被拒绝，因此暂且关闭防火墙。**在CentOS6.8系统中**，使用如下
命令关闭iptables防火墙。
```shell
service iptables stop
chkconfig iptables off
```
> 在CentOS7.X系统中，用firewalld替代了iptables。关闭防火墙的命令如下：
>
> systemctl stop firewalld.service
>
> systemctl disable firewalld.service 

#### 2.2.3.配置网卡文件
在CentOS6.8中编辑网卡配置文件的命令如下：
```shell
vi /etc/sysconfig/network-scripts/ifcfg-eth0
```
编辑内容如下：
```ini
#当前机器的IP地址
IPADDR=192.168.216.20
#固定的子网掩码地址
NETMASK=255.255.255.0
#网关地址
GATEWAY=192.168.216.2
#首选DNS，设置为网关的IP地址即可
DNS1=192.168.216.2
#备选DNS，设置为如下即可
DNS2=8.8.8.8
#设置为静态配置IP地址模式 
BOOTPROTO=static
#是否开机自动启动网卡
ONBOOT=yes
```
编辑完后，重启网卡：
```shell
service network restart
```
其余两台虚拟机网卡配置过程与上述过程基本一致。

#### 2.2.4.修改IP地址与主机名的映射关系 
```shell
vi /etc/hosts
```
将其修改为如下内容：
```ini
192.16.216.20 linux01
192.16.216.21 linux02
192.16.216.22 linux03
```

#### 2.2.5.实现3台虚拟机之间的无秘钥访问 
以其中一台虚拟机上的操作为例，首先，执行以下命令生成秘钥：
```shell
ssh-keygen -t rsa
```
然后，分发公钥至3台虚拟机，命令如下：
```shell
ssh-copy-id linux01;
ssh-copy-id linux02;
ssh-copy-id linux03;
```

#### 2.2.6.关闭桌面GUI
开发者几乎不会在Linux虚拟机中使用桌面UI，而是全部通过命令行进行系统操作，并且开启桌面UI会额外地 
增加系统的开销。因此可以考虑关闭GUI。

首先，在CentOS中关闭GUI需要 **编辑inittab文件**：
```shell
vi /etc/inittab
```
然后，**根据inittab文件中的描述，将其中的id修改为“2”**。

> 在CentOS7.X版本的系统中，关闭GUI的命令如下：
>
> systemctl set-default multi-user.target

#### 2.2.7.配置sudo权限
为方便普通用户临时使用更高的权限来执行命令，**需要编辑sudo文件来对普通用户进行授权**。首先编辑
sudo文件，具体命令如下：
```shell
visudo
```
然后在文件中增加如下内容：
```shell
admin ALL=(ALL) NOPASSWD: ALL
```

#### 2.2.8.配置时间服务器
三台虚拟机的系统时间应该是一致的。所以最好的方法是：**将第一台虚拟机配置为时间服务器，其余两台虚
拟 机通过ntpdate命令同步第一台虚拟机的时间，并将ntpdate命令配置到crontab脚本中，以使每隔若干
分钟同步一次**。具体操作这里不再详述。

#### 2.2.9.配置Java环境变量
系统变量与用户变量的配置文件所在位置分别如下所示：
+ 系统变量： /etc/profile
+ 用户变量：~/.bashrc

配置内容如下：
```shell
JAVA_HOME=/home/admin/modules/jdk1.8.0.121
export PATH=$PATH:$JAVA_HOME/bin
```

### 2.3.配置Windows中的hosts文件
在Windows中，为了可以通过虚拟机的主机名来访问虚拟机，最好将虚拟机的主机名与IP地址的映射关系保存
在Windows的“C:\Windows\System32\drivers\etc\hosts“文件中，示例内容如下：
```ini
192.168.216.20  linux01
192.168.216.21  linux02
192.168.216.22  linux03
```

## 3.了解目前集群中已经部署的框架服务 
**在生产环境中，完全独立地使用Spark的场景极其罕见**。大多数情况下Spark会与Hadoop及其他相关框
架配合使用。下表列出了目前在虚拟机中已部署的框架服务。

| 框架类别 | Linux01 | Linux02 | Linux03 |
|:--------|:--------|:--------|:--------|
| HDFS(Hadoop2.7.2) | NameNode, DataNode | DateNode | DataNode, SecondaryNameNode |
| YARN-MR(Hadoop2.7.2)|NodeManger, JobHistoryServer | ResourceManager, NodeManger | NodeManger |
| Zookeeper(Zookeeper3.4.x)|QuorumPeerMain | QuorumPeerMain | QuorumPeerMain |







