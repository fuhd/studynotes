用Oozie调度Sqoop异常问题（一）
================================================================================
## 1.BUG1

### 1.1.问题描述
环境为HDP3.1，在执行Oozie调度Sqoop Action为 **orc格式** 的表导入数据，报以下错误：
```
2019-07-13 18:06:05,818  WARN SqoopActionExecutor:523 - SERVER[server01.zjimee.com] USER[hive] GROUP[-] TOKEN[] APP[jtgk-wf] JOB[0000004-190713121208678-oozie-oozi-W] ACTION[0000004-190713121208678-oozie-oozi-W@sqoop_capital_construction_job] Launcher exception: org/apache/orc/OrcConf
java.lang.NoClassDefFoundError: org/apache/orc/OrcConf
	at org.apache.sqoop.util.OrcUtil.setOrcSchemaInConf(OrcUtil.java:89)
	at org.apache.sqoop.tool.ImportTool.importTable(ImportTool.java:535)
	at org.apache.sqoop.tool.ImportTool.run(ImportTool.java:656)
	at org.apache.sqoop.Sqoop.run(Sqoop.java:150)
	at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:76)
	at org.apache.sqoop.Sqoop.runSqoop(Sqoop.java:186)
	at org.apache.sqoop.Sqoop.runTool(Sqoop.java:240)
	at org.apache.sqoop.Sqoop.runTool(Sqoop.java:249)
	at org.apache.sqoop.Sqoop.main(Sqoop.java:258)
	at org.apache.oozie.action.hadoop.SqoopMain.runSqoopJob(SqoopMain.java:237)
	at org.apache.oozie.action.hadoop.SqoopMain.run(SqoopMain.java:214)
	at org.apache.oozie.action.hadoop.LauncherMain.run(LauncherMain.java:78)
	at org.apache.oozie.action.hadoop.SqoopMain.main(SqoopMain.java:59)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.oozie.action.hadoop.LauncherMapper.map(LauncherMapper.java:231)
	at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:54)
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:465)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:349)
	at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:174)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
```
我的`job.properties`如下：
```ini
nameNode=hdfs://server01.zjimee.com:8020
jobTracker=server01.zjimee.com:8050
queueName=default
appRoot=zjimee_fuhd

username=root
password=xxxxxx

oozie.use.system.libpath=true

oozie.wf.application.path=${nameNode}/user/${user.name}/${appRoot}/JTGK/apps
```

### 1.2.原因
通过分析是缺少ORC格式相关的jar包，我们浏览Oozie的`/user/0oozie/share/lib/lib_xxxxxx/sqoop`
目录，并没有发现orc相关的jar，查看`/user/0oozie/share/lib/lib_xxxxxx/hive2`下有两人orc
相关的jar包：`orc-core-1.5.1.3.1.0.0-78.jar`，`orc-shims-1.5.1.3.1.0.0-78.jar`（**注
意：不全，还缺少一个jar包，这会引出第二个BUG**）。

### 1.3.解决
在`job.properties`文件中引入`/user/0oozie/share/lib/lib_xxxxxx/hive2`目录为Sqoop所用：
```ini
nameNode=hdfs://server01.zjimee.com:8020
jobTracker=server01.zjimee.com:8050
queueName=default
appRoot=zjimee_fuhd

username=root
password=xxxxxx

oozie.use.system.libpath=true

#加入这一句，引入第三方库的目录
oozie.libpath=${nameNode}/user/oozie/share/lib/lib_20190709165044/hive2

oozie.wf.application.path=${nameNode}/user/${user.name}/${appRoot}/JTGK/apps
```

## 2.BUG2

### 2.1.问题描述
上面的BUG解决之后，再次运行Job又报了一个错误：
```
ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console. Set system property 'log4j2.debug' to show Log4j2 internal initialization logging.
Failing Oozie Launcher, Main class [org.apache.oozie.action.hadoop.SqoopMain], main() threw exception, org/apache/orc/mapreduce/OrcOutputFormat
java.lang.NoClassDefFoundError: org/apache/orc/mapreduce/OrcOutputFormat
	at org.apache.sqoop.mapreduce.DataDrivenImportJob.getOutputFormatClass(DataDrivenImportJob.java:218)
	at org.apache.sqoop.mapreduce.ImportJobBase.configureOutputFormat(ImportJobBase.java:94)
	at org.apache.sqoop.mapreduce.ImportJobBase.runImport(ImportJobBase.java:259)
	at org.apache.sqoop.manager.SqlManager.importTable(SqlManager.java:692)
	at org.apache.sqoop.manager.MySQLManager.importTable(MySQLManager.java:124)
	at org.apache.sqoop.tool.ImportTool.importTable(ImportTool.java:541)
	at org.apache.sqoop.tool.ImportTool.run(ImportTool.java:656)
	at org.apache.sqoop.Sqoop.run(Sqoop.java:150)
	at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:76)
	at org.apache.sqoop.Sqoop.runSqoop(Sqoop.java:186)
	at org.apache.sqoop.Sqoop.runTool(Sqoop.java:240)
	at org.apache.sqoop.Sqoop.runTool(Sqoop.java:249)
	at org.apache.sqoop.Sqoop.main(Sqoop.java:258)
	at org.apache.oozie.action.hadoop.SqoopMain.runSqoopJob(SqoopMain.java:237)
	at org.apache.oozie.action.hadoop.SqoopMain.run(SqoopMain.java:214)
	at org.apache.oozie.action.hadoop.LauncherMain.run(LauncherMain.java:78)
	at org.apache.oozie.action.hadoop.SqoopMain.main(SqoopMain.java:59)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.oozie.action.hadoop.LauncherMapper.map(LauncherMapper.java:231)
	at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:54)
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:465)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:349)
	at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:174)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1730)
```

### 2.2.原因
原因就是还缺少一个orc的jar包。但我直接使用`sqoop`命令是可以直接导成功的，命令如下：
```shell
sqoop import --connect jdbc:mysql://xxx.xxx.xxx.xxx:3306/road_monitor --username root --password 123 --table accident_info --hive-import --hive-overwrite --hive-database road_monitor --hive-table ods_road_monitor_accident_info_1 --as-orcfile -m 1
```
那就证明HDP的环境里是有缺少的jar包的，只是没有放到Oozie的shareLib目录中。在HDP服务器的节点上
执行搜索：
```shell 
find / -name *orc*.jar
```
输出:
```
......
/usr/hdp/3.1.0.0-78/sqoop/lib/orc-core-1.5.1.3.1.0.0-78.jar
/usr/hdp/3.1.0.0-78/sqoop/lib/orc-shims-1.5.1.3.1.0.0-78.jar
/usr/hdp/3.1.0.0-78/sqoop/lib/orc-mapreduce-1.5.1.3.1.0.0-78.jar
......
```

### 2.3.解决
发现缺少`rc-mapreduce-1.5.1.3.1.0.0-78.jar`，而且这三个jar包都是放在sqoop的lib目录中的。
为了避免jar包的冲突（`${nameNode}/user/oozie/share/lib/lib_20190709165044/hive2`目录
下的jar包非常多），**我们就在`job.properties`中删除
`oozie.libpath=${nameNode}/user/oozie/share/lib/lib_20190709165044/hive2`**。把这
三个jar包直接导入到`${nameNode}/user/oozie/share/lib/lib_20190709165044/sqoop`目录中。

**再在Ambari中重启Oozie服务**，完美解决。