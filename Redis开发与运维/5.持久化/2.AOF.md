AOF
====================================================================

### 使用AOF
开启AOF功能需要设置配置：**`appendonly yes`，默认不开启**。AOF文件名通过 **`appendfilename`** 配置设置，
**默认文件名是`appendonly.aof`**。保存路径同RDB持久化方式一致，通过 **dir** 配置指定。AOF的工作流程操作：
**命令写入（append）、文件同步（sync）、文件重写（rewrite）、重启加载（load）**。

流程如下：
1. 所有的写入命令会追加到 **`aof_buf`** （缓冲区）中。
2. AOF缓冲区根据对应的策略向硬盘做同步操作。
3. 随着AOF文件越来越大，需要定期对AOF文件 **进行重写，达到压缩的目的**。
4. 当Redis服务器重启时，可以加载AOF文件进行数据恢复。

### 命令写入
AOF命令写入的内容直接是 **文本协议格式**。例如`set hello world`这条命令，在 **AOF缓冲区** 会追加如下文本：
```
＊3\r\n$3\r\nset\r\n$5\r\nhello\r\n$5\n\nworld\r\n
```
这里介绍关于AOF的两个疑惑：
1. AOF为什么直接采用文本协议格式？可能的理由如下：
  + 文本协议具有很好的兼容性。
  + 开启AOF后，所有写入命令都包含追加操作，直接采用协议格式，避免了一次处理开始。
  + 文本协议具有可读性，方便直接修改和处理。
2. AOF为什么把命令追加到`aof_buf`中？**Redis使用单线程响应命令，如果每次写AOF文件命令都直接追加到硬盘，
那么性能完全取决于当前硬盘负载。先写入缓冲区`aof_buf`中，还有另一个好处，Redis可以提供多种缓冲区同步硬盘的策略**，
在性能和完全性方面做出平衡。

### 文件同步
Redis提供了 **多种** AOF缓冲区同步文件策略，由参数 **`appendfsync`** 控制，不同值的含义如下：

| 可配置值 | 说明 |
|-------- | :-- |
| always | 命令写入`aof_buf`后调用系统`fsync`操作同步到AOF文件，`fsync`完成后线程返回 |
