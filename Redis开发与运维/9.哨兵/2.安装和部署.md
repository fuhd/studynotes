安装和部署
================================================================
### 部署拓扑结构
示例，以3个Sentinel节点、1个Redis主节点、2个Redis从节点组成一个Redis Sentinel进行说明。

| 角色 | IP | Port | 别名（为了后文中方便）|
| :---| :----|:-----|:------------------|
| master | 127.0.0.1 | 6379 | 主节点或者6379节点 |
| slave-1 | 127.0.0.1 | 6380 | slave-1节点或者6380节点 |
| slave-2 | 127.0.0.1 | 6381 | slave-2节点或者6381节点 |
| sentinel-1 | 127.0.0.1 | 26379 | sentinel-1节点或者26379节点 |
| sentinel-2 | 127.0.0.1 | 26380 | sentinel-2节点或者26380节点 |
| sentinel-3 | 127.0.0.1 | 26381 | sentinel-3节点或者26381节点 |

### 部署Redis数据节点
目前，Redis Sentinel中Redis数据节点没有做任何特殊配置。

#### 启动主节点
配置：redis-7379.conf
```
port 6379
daemonize yes
logfile "6379.log"
dbfilename "dump-6379.rdb"
dir "/opt/soft/redis/data/"
......
```
启动主节点：
```shell
$ redis-server redis-6379.conf
```

#### 启动两个从节点
配置：两个从节点配置是完全一样的，只是与主节点配置有点区别（添加了`slaveof`配置）,见redis-6380.conf
```
port 6380
daemonize yes
logfile "6380.log"
dbfilename "dump-6380.rdb"
dir "/opt/soft/redis/data/"
slaveof 127.0.0.1 6379
```
这里只显式配置一下6380节点。

启动两个从节点：
```shell
redis-server redis-6380.conf
redis-server redis-6381.conf
```
验证：
```shell
$ redis-cli -h 127.0.0.1 -p 6380 ping
PONG
$ redis-cli -h 127.0.0.1 -p 6381 ping
PONG
```

#### 确认主从关系
主节点的视角，它有两个从节点：
```shell
$ redis-cli -h 127.0.0.1 -p 6379 info replication 
# Replication
role:master
connected_slaves:2
slave0:ip=127.0.0.1,port=6380,state=online,offset=281,lag=1
slave1:ip=127.0.0.1,port=6381,state=online,offset=281,lag=0
.......................
```
从节点的视角，它的主节点是127.0.0.1:6379:
```shell
$ redis-cli -h 127.0.0.1 -p 6380 info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:up
.......................
```

### 部署Sentinel节点
3个Sentinel节点的部署方法是完全一致的（**端口不同**）：

#### 配置Sentinel节点
redis-sentinel-26379.conf：
```
port 26379
daemonize yes
logfile "26379.log"
dir /opt/soft/redis/data
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```
1. Sentinel节点的默认端口是26379;
2. `sentinel monitor mymaster 127.0.0.1 6379 2`配置代表`sentinel-1`
    节点需要监控`127.0.0.1:6379`这个主节点，`2`代表判断主节点失败至少需要`2`
    个Sentinel节点同意，`mymaster`是主节点的别名，其它配置稍后再讲。

#### 启动Sentinel节点
Sentinel节点的启动方法有 **两种**：
1. 使用`redis-sentinel`命令：
```shell
$ redis-sentinel redis-sentinel-26379.conf
```
2. 使用`redis-server`命令加`--sentinel`参数：
```shell
$ redis-server redis-sentinel-26379.conf --sentinel
```

#### 确认
Sentinel节点本质上是一个特殊的Redis节点，所以也可以通过`info`命令来查询它的相关信息：
```shell
$ redis-cli -h 127.0.0.1 -p 26379 info Sentinel
```
```
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3
```
从上面`info`的Sentinel片段来看，Sentinel节点找到了主节点`127.0.0.1:6379`，
发现了它的两个从节点，同时发现Redis Sentinel一共有3个Sentinel节点。这里只需要了解Sentinel
节点能够彼此感知到对方，同时能够感知到Redis数据节点就可以了；**这里有两点需要强调一下**：
1. **生产环境中建议Redis Sentinel的所有节点应该分布在不同的物理机上**。
2. **Redis Sentinel中的数据节点和普通的Redis数据节点在配置上没有任何区别，只不过是添加了一些Sentinel节点对它们进行监控**。

### 配置优化
本节将对每个配置的使用和优化进行详细介绍。**Redis安装目录下有一个`sentinel.conf`，是默认的Sentinel节点配置文件**。
下面以它作为例子进行说明。

#### 配置说明和优化
```shell
port 26379
dir /opt/soft/redis/data
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
#sentinel auth-pass <master-name> <password>
#sentinel notification-script <master-name> <script-path>
#sentinel client-reconfig-script <master-name> <script-path>
```
**`port`和`dir`分别代表Sentinel节点的端口和工作目录**。

下面重点对sentinel相关配置进行详细说明。

1. **`sentinel monitor`**

配置如下：
```
sentinel monitor <master-name> <ip> <port> <quorum>
```
本配置说明Sentinel节点要监控的是一个 **名字** 叫做`<master-name>`，**ip地址** 和 **端口** 为`<ip>`、`<port>`
的主节点。`<quorum>`代表要 **判定主节点最终不可达所需要的票数**。但实际上Sentinel节点会对所有
节点进行监控，但是在Sentinel节点的配置中没有看到有关从节点和其余Sentinel节点的配置，**那是因为Sentinel节点会**
**从主节点中获取有关从节点以及其余Sentinel节点的相关信息**。

例如某个Sentinel初始节点配置如下：
```shell
port 26379
daemonize yes
logfile "26379.log"
dir /opt/soft/redis/data
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```
当所有节点启动后，**配置文件中的内容发生了变化，体现在三个方面**：
+ Sentinel节点自动发现了从节点、其余Sentinel节点。
+ 去掉了默认配置，例如`parallel-syncs`、`failover-timeout`参数。
+ 添加了配置纪元相关参数。

**启动后变化为**：
```shell
port 26379
daemonize yes
logfile "26379.log"
dir /opt/soft/redis/data
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
# 发现两个slave节点
sentinel known-slave mymaster 127.0.0.1 6380
sentinel known-slave mymaster 127.0.0.1 6381
# 发现两个sentinel节点
sentinel known-sentinel mymaster 127.0.0.1 26380 282a70ff56c36ed56e8f7ee6ada74124140d6f53
sentinel known-sentinel mymaster 127.0.0.1 26381 f714470d30a61a8e39ae031192f1feae7eb5b2be
sentinel current-epoch 0
```
**`<quorum>`参数用于故障发现和判定，例如将quorum配置为2，代表至少有2个Sentinel节点认为主节点不可达，**
**那么这个不可达的判定才是客观的。对于`<quorum>`设置的越小，那么达到下线的条件越宽松，反之越严格。**
**一般建议将其设置为Sentinel节点的一半加1**。

**同时`<quorum>`还与Sentinel节点的领导者选举有关，至少要有`max(quorum,num(sentinels)/2+1)`个sentinel节点**
**参与选举，才能选出领导者Sentinel，从而完成故障转移**。例如有5个Sentinel节点，quorum=4，
那么至少要有`max(quorum,num(sentinels)/2+1)=4`个在线Sentinel节点才可以进行领导者选举。

2. **`sentinel down-after-milliseconds`**

配置如下：
```
sentinel down-after-milliseconds <master-name> <times>
```
每个Sentinel节点都要通过定期发送ping命令来判断Redis数据节点和其余Sentinel节点是否可达，
如果超过了`down-after-milliseconds`配置的时间且没有有效的回复，则判定节点不可达，
`times`（单位为毫秒）就是超时时间。这个配置是对节点失败判定的重要依据。

**优化说明**：`down-after-milliseconds`越大，代表Sentinel节点对于节点不可达的条件越宽松，反之越严格。
条件宽松有可能带来的问题是节点确实不可达了，那么应用方需要等待故障转移的时间越长，
也就意味着应用方故障时间可能越长。条件严格虽然可以及时发现故障完成故障转移，但是也存在一定的误判率。

**注意：`down-after-milliseconds`虽然以`<master-name>`为参数，但实际上对Sentinel节点、主节点、从节点的失败判定同时有效**。

3. **`sentinel parallel-syncs`**

配置如下：
```
sentinel parallel-syncs <master-name> <nums>
```
**当Sentinel节点集合对主节点故障判定达成一致时，Sentinel领导者节点会做故障转移操作**，
**选出新的主节点，原来的从节点会向新的主节点发起复制操作，`parallel-syncs`就是用来限制在一次故障转移之后**，
**每次向新的主节点发起复制操作的从节点个数**。如果这个参数配置的比较大，那么多个从节点会向新的主节点
同时发起复制操作，尽管复制操作通常不会阻塞主节点，但是同时向主节点发起复制，必然会对主节点所在的机器造成
一定的网络和磁盘IO开销。例如：`parallel-syncs=3`会同时发起复制，`parallel-syncs=1`时从节点会轮询发起复制。

4. **`sentinel failover-timeout`**

配置如下：
```
sentinel failover-timeout <master-name> <times>
```









