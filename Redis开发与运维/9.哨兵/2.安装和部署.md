安装和部署
================================================================
### 部署拓扑结构
示例，以3个Sentinel节点、1个Redis主节点、2个Redis从节点组成一个Redis Sentinel进行说明。

| 角色 | IP | Port | 别名（为了后文中方便）|
| :---| :----|:-----|:------------------|
| master | 127.0.0.1 | 6379 | 主节点或者6379节点 |
| slave-1 | 127.0.0.1 | 6380 | slave-1节点或者6380节点 |
| slave-2 | 127.0.0.1 | 6381 | slave-2节点或者6381节点 |
| sentinel-1 | 127.0.0.1 | 26379 | sentinel-1节点或者26379节点 |
| sentinel-2 | 127.0.0.1 | 26380 | sentinel-2节点或者26380节点 |
| sentinel-3 | 127.0.0.1 | 26381 | sentinel-3节点或者26381节点 |

### 部署Redis数据节点
目前，Redis Sentinel中Redis数据节点没有做任何特殊配置。

#### 启动主节点
配置：redis-7379.conf
```
port 6379
daemonize yes
logfile "6379.log"
dbfilename "dump-6379.rdb"
dir "/opt/soft/redis/data/"
......
```
启动主节点：
```shell
$ redis-server redis-6379.conf
```

#### 启动两个从节点
配置：两个从节点配置是完全一样的，只是与主节点配置有点区别（添加了`slaveof`配置）,见redis-6380.conf
```
port 6380
daemonize yes
logfile "6380.log"
dbfilename "dump-6380.rdb"
dir "/opt/soft/redis/data/"
slaveof 127.0.0.1 6379
```
这里只显式配置一下6380节点。

启动两个从节点：
```shell
redis-server redis-6380.conf
redis-server redis-6381.conf
```
验证：
```shell
$ redis-cli -h 127.0.0.1 -p 6380 ping
PONG
$ redis-cli -h 127.0.0.1 -p 6381 ping
PONG
```

#### 确认主从关系
主节点的视角，它有两个从节点：
```shell
$ redis-cli -h 127.0.0.1 -p 6379 info replication 
# Replication
role:master
connected_slaves:2
slave0:ip=127.0.0.1,port=6380,state=online,offset=281,lag=1
slave1:ip=127.0.0.1,port=6381,state=online,offset=281,lag=0
.......................
```
从节点的视角，它的主节点是127.0.0.1:6379:
```shell
$ redis-cli -h 127.0.0.1 -p 6380 info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:up
.......................
```

### 部署Sentinel节点
3个Sentinel节点的部署方法是完全一致的（**端口不同**）：

#### 配置Sentinel节点
redis-sentinel-26379.conf：
```
port 26379
daemonize yes
logfile "26379.log"
dir /opt/soft/redis/data
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```
1. Sentinel节点的默认端口是26379;
2. `sentinel monitor mymaster 127.0.0.1 6379 2`配置代表`sentinel-1`
    节点需要监控`127.0.0.1:6379`这个主节点，`2`代表判断主节点失败至少需要`2`
    个Sentinel节点同意，`mymaster`是主节点的别名，其它配置稍后再讲。

#### 启动Sentinel节点
Sentinel节点的启动方法有 **两种**：
1. 使用`redis-sentinel`命令：
```shell
$ redis-sentinel redis-sentinel-26379.conf
```
2. 使用`redis-server`命令加`--sentinel`参数：
```shell
$ redis-server redis-sentinel-26379.conf --sentinel
```

#### 确认
Sentinel节点本质上是一个特殊的Redis节点，所以也可以通过`info`命令来查询它的相关信息：
```shell
$ redis-cli -h 127.0.0.1 -p 26379 info Sentinel
```
```
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3
```
从上面`info`的Sentinel片段来看，Sentinel节点找到了主节点`127.0.0.1:6379`，
发现了它的两个从节点，同时发现Redis Sentinel一共有3个Sentinel节点。这里只需要了解Sentinel
节点能够彼此感知到对方，同时能够感知到Redis数据节点就可以了；**这里有两点需要强调一下**：
1. **生产环境中建议Redis Sentinel的所有节点应该分布在不同的物理机上**。
2. **Redis Sentinel中的数据节点和普通的Redis数据节点在配置上没有任何区别，只不过是添加了一些Sentinel节点对它们进行监控**。

### 配置优化
本节将对每个配置的使用和优化进行详细介绍。**Redis安装目录下有一个`sentinel.conf`，是默认的Sentinel节点配置文件**。





