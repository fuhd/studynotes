apache commons-daemon的使用
================================================================================
## 1.apache commons-daemon介绍
`Apache common deamon`是用来把 **java程序安装成系统服务的开源软件，将一个普通的Java应用变成
系统的一个后台服务，在linux下部署为后台运行程序，在windows部署为windows服务**，我们在这里主要
讲解把java程序以Linux服务的方式进行安装。

### 1.1.平台
支持Win32和UNIX类平台。对于Win32平台，请使用 **procrun**。对于类似UNIX的平台，请使用 **jsvc**。

### 1.2.Jsvc

#### 1.2.1.介绍
**Jsvc是一组库和应用程序**，用于使Java应用程序更容易在UNIX上运行。Jsvc允许应用程序（例如Tomcat）
以root身份执行某些特权操作（例如绑定到端口<1024），然后将身份切换到非特权用户。它可以通过Cygwin
仿真层在Win32上运行（有关更多信息，请参阅Cygwin），**但Win32用户可能更喜欢使用procrun，这允许
应用程序作为Windows服务运行**。源位于`src/native/unix`子目录中。

#### 1.2.2.从源代码构建Jsvc
要在UNIX操作系统下构建二进制文件，您需要：
+ 符合ANSI-C标准的编译器（GCC很好）
+ GNU Make
+ 符合Java Platform 2的SDK

您必须使用 **`--with-java = <dir>`参数指定SDK的JAVA_HOME**，或者 **将JAVA_HOME环境设置
为指向Java SDK安装**。例如：
```shell
./configure --with-java=/usr/java
```
或者：
```shell
export JAVA_HOME
./configure
```
要构建二进制文件和库，只需执行以下操作：
```shell
make
```
**这将生成可执行文件jsvc**。

#### 1.2.3.启动jsvc
要检查 **jsvc二进制文件的允许参数**，只需执行以下操作：
```shell
./jsvc -help
```
```
Usage: jsvc [-options] class [args...]

Where options include:

    -help | --help | -?
        show this help page (implies -nodetach)
    -jvm <JVM name>
        use a specific Java Virtual Machine. Available JVMs:
            'server'
    -client
        use a client Java Virtual Machine.
    -server
        use a server Java Virtual Machine.
    -cp | -classpath <directories and zip/jar files>
        set search path for service classes and resouces
    -java-home | -home <directory>
        set the path of your JDK or JRE installation (or set
        the JAVA_HOME environment variable)
    -version
        show the current Java environment version (to check
        correctness of -home and -jvm. Implies -nodetach)
    -showversion
        show the current Java environment version (to check
        correctness of -home and -jvm) and continue execution.
    -nodetach
        don't detach from parent process and become a daemon
    -debug
        verbosely print debugging information
    -check
        only check service (implies -nodetach)
    -user <user>
        user used to run the daemon (defaults to current user)
    -verbose[:class|gc|jni]
        enable verbose output
    -cwd </full/path>
        set working directory to given location (defaults to /)
    -outfile </full/path/to/file>
        Location for output from stdout (defaults to /dev/null)
        Use the value '&2' to simulate '1>&2'
    -errfile </full/path/to/file>
        Location for output from stderr (defaults to /dev/null)
        Use the value '&1' to simulate '2>&1'
    -pidfile </full/path/to/file>
        Location for output from the file containing the pid of jsvc
        (defaults to /var/run/jsvc.pid)
    -D<name>=<value>
        set a Java system property
    -X<option>
        set Virtual Machine specific option
    -ea[:<packagename>...|:<classname>]
    -enableassertions[:<packagename>...|:<classname>]
        enable assertions
    -da[:<packagename>...|:<classname>]
    -disableassertions[:<packagename>...|:<classname>]
        disable assertions
    -esa | -enablesystemassertions
        enable system assertions
    -dsa | -disablesystemassertions
        disable system assertions
    -agentlib:<libname>[=<options>]
        load native agent library <libname>, e.g. -agentlib:hprof
    -agentpath:<pathname>[=<options>]
        load native agent library by full pathname
    -javaagent:<jarpath>[=<options>]
        load Java programming language agent, see java.lang.instrument
    -procname <procname>
        use the specified process name
    -wait <waittime>
        wait waittime seconds for the service to start
        waittime should multiple of 10 (min=10)
    -restarts <maxrestarts>
        maximum automatic restarts (integer)
        -1=infinite (default), 0=none, 1..(INT_MAX-1)=fixed restart count
    -stop
        stop the service using the file given in the -pidfile option
    -keepstdin
        does not redirect stdin to /dev/null
    --add-modules=<module name>
        Java 9 --add-modules option. Passed as it is to JVM
    --module-path=<module path>
        Java 9 --module-path option. Passed as it is to JVM
    --upgrade-module-path=<module path>
        Java 9 --upgrade-module-path option. Passed as it is to JVM
    --add-reads=<module name>
        Java 9 --add-reads option. Passed as it is to JVM
    --add-exports=<module name>
        Java 9 --add-exports option. Passed as it is to JVM
    --add-opens=<module name>
        Java 9 --add-opens option. Passed as it is to JVM
    --limit-modules=<module name>
        Java 9 --limit-modules option. Passed as it is to JVM
    --patch-module=<module name>
        Java 9 --patch-module option. Passed as it is to JVM
    --illegal-access=<value>
        Java 9 --illegal-access option. Passed as it is to JVM. Refer java help for possible values.

jsvc (Apache Commons Daemon) 1.1.0
Copyright (c) 1999-2017 Apache Software Foundation.
```








## 2.linux下使用commons-daemon

### 2.1.下载commons-daemon
到[commons-daemon官网](http://commons.apache.org/proper/commons-daemon/download_daemon.cgi)下载，
其中需要下载 **commons-daemon主程序** 和 **jsvc包（源码包）**。如下图：

![commons-daemon包](img/1.png)

+ 下载 **commons-daemon-1.1.0-bin.tar.gz**，解压出 **commons-daemon-1.1.0.jar** 放
到程序目录中，以便使用。
+ 下载 **commons-daemon-1.1.0-src.tar.gz** 源码包，**此程序用于在linux下使用源码方式安装
jsvc**。（提醒：在官网的jsvc只讲解了如何安装及使用，源码需要在这里下载）。

### 2.2.安装jsvc
可先查看 [官网的jsvc](http://commons.apache.org/proper/commons-daemon/jsvc.html)，本
示例中安装如下，**把commons-daemon源码包放到/opt目录下**。操作如下：
```shell
$ cd /opt/jsvc/
$ sudo tar xzvf commons-daemon-1.1.0-src.tar.gz
$ cd /opt/jsvc/commons-daemon-1.1.0-src/src/native/unix/
$ sudo ./configure --with-java=/opt/jdk1.8.0_144
```
显示：
```
......
......
*** Writing output files ***
configure: creating ./config.status
config.status: creating Makefile
config.status: creating Makedefs
config.status: creating native/Makefile
*** All done ***
Now you can issue "make"
```
```shell
$ sudo make
```
说明:
> 确保linux上已安装java，安装需依赖java，如上述操作中: --with-java=/opt/jdk1.8.0_144
> make完后，会在commons-daemon-1.0.15-src/src/native/unix下生成jsvc文件

![jsvc文件](img/2.png)

> 记住此jsvc路径，安装时使用

### 2.3.编写程序入口类
简单的打印日志程序：
```java

```
**入口类只需要实现`init`,`destroy`,`start`,`stop`方法即可，安装时指定此类，jsvc会根据这些
方法进行初始化、启动、关闭等操作**。程序如下：
```java

```
说明：
+ `init`方法有参数，`destroy`、`start`及`stop`方法无参。
+ `start`方法作启动入口，`stop`方法为关闭，本示例简单退出程序，若需要自定义操作，可在此方法编
写即可。

### 2.4.编写安装脚本
```

```






























dd
