用State替换状态改变条件语句（状态模式）
========================================================================

### 动机
**重构实现`State`模式的主要原因，是为了对付过度复杂的状态改变条件逻辑。这种逻辑往往散布在整个类中，
控制对象的状态以及状态之间的转换**。在实现`State`模式的时候，需要创建代表对象特殊状态和状态间转换的类。
在《设计模式》中，**包含状态改变的对象称为上下文**。上下文会 **把状态相关的行为委托到状态对象上**。
通过使上下文引用不同的状态对象，状态对象可以在运行时实现状态转换。 
```
State和Strategy不同。State模式作用于必须能够很方便地在一系列状态类的实例间转换的类，而Strategy模式
作用于把算法的执行委托到一系列策略类的实例的类。由于这种差异，重构到这两种模式的动机和做法也不尽相同。
```

### 优点与缺点
+ (＋)减少或去除状态改变条件逻辑；
+ (＋)简化了复杂的状态改变逻辑；
+ (＋)提供了观察状态改变逻辑的很好的鸟瞰图；
+ (－)当状态转换逻辑已经易于理解的时候，会增加设计的复杂度；

### 做法

![状态模式](img/state.png)

这里以一个贴近现实生活的例子来展示如何使用该设计模式。例子，某人去银行新开一个帐户，该帐户可以用来存钱或者取钱，
我们可以以帐户中的总资金来判断显示某用户帐户的状态：红色状态（`RedState`）、银色状态（`SliverState`）、
金色状态（`GoldState`）。其实就好比银行中根据我们存储卡中的资金来给客户某种身份的识别，例如普通用户、VIP用户、
公司客户...等等。

#### 类结构
+ state
    + GoldState.java
    + RedState.java
    + SilverState.java
    + State.java
+ context
    + Account.java
+ StateClient.java

#### java源代码
```java
package com.fuhd.state;

import com.fuhd.context.Account;

/**
 * state类，抽象状态类
 */
public abstract class State {

    protected Account account;
    protected double balance;
    protected double interest;
    protected double lowerLimit;
    protected double upperLimit;

    public Account getAccount() {
        return account;
    }

    public void setAccount(Account account) {
        this.account = account;
    }

    public double getBalance() {
        return balance;
    }

    public void setBalance(double balance) {
        this.balance = balance;
    }

    //存入金额
    public abstract void deposit(double amount);

    //支出金额
    public abstract void withdraw(double amount);

    //利息
    public abstract void payInterest();
}
```
```java
package com.fuhd.state;

/**
 * 用户账户状态: RedState
 * 具体状态，每一个子类实现一个与Context的一个状态相关的行为
 */
public class RedState extends State {

    private double serviceFee;

    public RedState(State state) {
        this.balance = state.getBalance();
        this.account = state.getAccount();
    }

    private void initialize() {
        interest = 0.0;
        lowerLimit = -100.0;
        upperLimit = 0.0;
        serviceFee = 15.00;
    }

    @Override
    public void deposit(double amount) {
        balance += amount;
        stateChangeCheck();
    }

    @Override
    public void withdraw(double amount) {
        amount = amount - serviceFee;
        System.out.println("No funds available for withdrawal!");
    }

    @Override
    public void payInterest() {
        //No interest is paid
    }

    private void stateChangeCheck() {
        if (balance > upperLimit) {
            account.setState(new SilverState(this));
        }
    }
}
```
```java
package com.fuhd.state;

import com.fuhd.context.Account;

/**
 * 用户帐户状态： SilverState
 * 具体状态，每一个子类实现一个与Context的一个状态相关的行为
 */
public class SilverState extends State {

    public SilverState(State state) {

    }

    public SilverState(double balance, Account account) {
        this.balance = balance;
        this.account = account;
        initialize();
    }

    /**
     * 模拟初始化基础数据
     */
    private void initialize() {
        interest = 0.0;
        lowerLimit = 0.0;
        upperLimit = 1000.0;
    }

    @Override
    public void deposit(double amount) {
        balance += amount;
        stateChangeCheck();
    }

    @Override
    public void withdraw(double amount) {
        balance -= amount;
        stateChangeCheck();
    }

    @Override
    public void payInterest() {
        balance += interest * balance;
    }

    private void stateChangeCheck() {
        if (balance < lowerLimit) {
            account.setState(new RedState(this));
        } else if (balance > upperLimit) {
            account.setState(new GoldState(this));
        }
    }
}
```
```java
package com.fuhd.state;

import com.fuhd.context.Account;

/**
 * 用户帐户状态： GoldState
 * 具体状态，每一个子类实现一个与Context的一个状态相关的行为
 */
public class GoldState extends State {

    public GoldState(State state) {
        this(state.balance, state.account);

    }

    public GoldState(double balance, Account account) {
        this.balance = balance;
        this.account = account;
        initialize();
    }

    /**
     * 模拟初始化基础数据
     */
    private void initialize() {
        interest = 0.05;
        lowerLimit = 1000.0;
        upperLimit = 10000000.0;
    }

    @Override
    public void deposit(double amount) {
        balance += amount;
        stateChangeCheck();
    }

    @Override
    public void withdraw(double amount) {
        balance -= amount;
        stateChangeCheck();
    }

    @Override
    public void payInterest() {
        balance += interest * balance;
        stateChangeCheck();
    }

    /**
     * 状态检测
     */
    private void stateChangeCheck() {
        if (balance < 0.0) {
            account.setState(new RedState(this));
        } else if (balance < lowerLimit) {
            account.setState(new SilverState(this));
        }
    }
}
```
```java
package com.fuhd.context;

import com.fuhd.state.SilverState;
import com.fuhd.state.State;

public class Account {

    private State state;
    private String owner;

    public Account(String owner) {
        //新开帐户默认Silver状态
        this.owner = owner;
        this.state = new SilverState(0.0, this);
    }

    public State getState() {
        return state;
    }

    public void setState(State state) {
        this.state = state;
    }

    public void deposit(double amount) {
        state.deposit(amount);
        System.out.println(owner + " Deposited  " + amount);
        System.out.println(owner + " Balance =  " + state.getBalance());
        System.out.println("Status = " + state.getClass().getSimpleName());
        System.out.println("==============================================");
    }

    public void withdraw(double amount) {
        state.withdraw(amount);
        System.out.println(owner + " Withdrew  " + amount);
        System.out.println(owner + " Balance =  " + state.getBalance());
        System.out.println("Status = " + state.getClass().getSimpleName());
        System.out.println("==============================================");
    }

    public void payInterest() {
        state.payInterest();
        System.out.println(owner + " Interest Paid  ");
        System.out.println(owner + " Balance =  " + state.getBalance());
        System.out.println("Status = " + state.getClass().getSimpleName());
        System.out.println("==============================================");
    }
}
```
```java
package com.fuhd.dp;

import com.fuhd.context.Account;

public class StateClient {
    public static void main(String[] args) {
        // 新开一个银行账户
        Account account = new Account("Andy.Chen");

        // 存取款等系列操作
        account.deposit(500.0);
        account.deposit(300.0);
        account.deposit(550.0);
        account.payInterest();
        account.withdraw(2000.00);
        account.withdraw(1100.00);
    }
}
```

#### 总结
状态模式主要解决的是当 **控制一个对象状态转换的条件表达式过于复杂时的情况**。把状态的判断逻辑转移到表示不同状态的一系列类当中，
可以把复杂的判断逻辑简化。**当一个对象的行为取决于它的状态，并且它必须在运行时刻根据状态改变它的行为时，就可以考虑使用状态模式了**。

