Spring Security示例
============================
### 先来看一个完整的示例代码
#### Domain Model
```java
//领域模型
@Entity
@Table(name = "user")
public class User {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  @Column(name = "id",nullable = false,updatable = false)
  private Long id;
  @Column(name = "email", nullable = false, unique = true)
  private String email;
  @Column(name = "password_hash", nullable = false)
  private String passwordHash;
  @Column(name = "role", nullable = false)
  @Enumerated(EnumType.STRING)
  private Role role;
  //getters,setters
}
//枚举类
public enum Role {
  USER, ADMIN
}
//与form对应的类
public class UserCreateForm {
  @NotEmpty
  private String email = "";
  @NotEmpty
  private String password = "";
  @NotEmpty
  private String passwordRepeated = "";
  @NotNull
  private Role role = Role.USER;
}
```
#### Service
```java
//Service层接口
public interface UserService {
  Optional<User> getUserById(long id);
  Optional<User> getUserByEmail(String email);
  Collection<User> getAllUsers();
  User create(UserCreateForm form);
}
//Service层实现
@Service
public class UserServiceImpl implements UserService {
  private final UserRepository userRepository;
  @Autowired
  public UserServiceImpl(UserRepository userRepository) {
    this.userRepository = userRepository;
  }
  @Override
  public Optional<User> getUserById(long id) {
    return Optional.ofNullable(userRepository.findOne(id));
  }
  @Override
  public Optional<User> getUserByEmail(String email) {
    return  userRepository.findOneByEmail(email);
  }
  @Override
  public Collection<User> getAllUsers() {
    return userRepository.findAll(new Sort("email"));
  }
  @Override
  public User create(UserCreateForm form) {
    User user = new User();
    user.setEmail(form.getEmail());
    user.setPasswordHash(new BCryptPasswordEncoder().encode(form.getPassword()));
    user.setRole(form.getRole());
    return userRepository.save(user);
  }
}
```
#### Dao
```java
public interface UserRepository extends JpaRepository<User,Long> {
  Optional<User> findOneByEmail(String email);
}
```
#### Controller
```java
//home
@Controller
public class HomeController {
  @RequestMapping("/")
  public String getHomePage() {
    return "home";
  }
}
//Users
@Controller
public class UsersController {
  private final UserService userService;
  @Autowired
  public UsersController(UserService userService) {
    this.userService  = userService;
  }
  @RequestMapping("/users")
  public ModelAndView getUsersPage() {
    return new ModelAndView("users", "users", userService.getAllUsers());
  }
}
//User
@Controller
public class UserController {
  private final UserService userService;
  private final UserCreateFormValidator userCreateFormValidator;
  @Autowired
  public UserController(UserService userService, UserCreateFormValidator userCreateFormValidator) {
    this.userService = userService;
    this.userCreateFormValidator = userCreateFormValidator;
  }
  @InitBinder("form")
  public void initBinder(WebDataBinder binder) {
    binder.addValidators(userCreateFormValidator);
  }
  @RequestMapping("/user/{id}")
  public ModelAndView getUserPage(@PathVariable Long id) {
    return new ModelAndView("user", "user", userService.getUserById(id).orElseThrow(
      () -> new NoSuchElementException(String.format("User=%s not found", id))));
  }
  @RequestMapping(value = "/user/create", method = RequestMethod.GET)
  public ModelAndView getUserCreatePage() {
    return new ModelAndView("user_create", "form", new UserCreateForm());
  }
  @RequestMapping(value = "/user/create", method = RequestMethod.POST)
  public String handleUserCreateForm(@Valid @ModelAttribute("form") UserCreateForm form,
      BindingResult bindingResult) {
    if(bindingResult.hasErrors()) {
      return "user_create";
    }
    try {
      userService.create(form);
    } catch (DataIntegrityViolationException e) {
      bindingResult.reject("email.exists", "Email already exists");
      return "user_create";
    }
    return "redirect:/users";
  }
}
```
