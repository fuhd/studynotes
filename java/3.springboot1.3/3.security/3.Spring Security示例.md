Spring Security示例
============================
### 先来看一个完整的示例代码
#### Domain Model
```java
//领域模型
@Entity
@Table(name = "user")
public class User {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  @Column(name = "id",nullable = false,updatable = false)
  private Long id;
  @Column(name = "email", nullable = false, unique = true)
  private String email;
  @Column(name = "password_hash", nullable = false)
  private String passwordHash;
  @Column(name = "role", nullable = false)
  @Enumerated(EnumType.STRING)
  private Role role;
  //getters,setters
}
//枚举类
public enum Role {
  USER, ADMIN
}
//与form对应的类
public class UserCreateForm {
  @NotEmpty
  private String email = "";
  @NotEmpty
  private String password = "";
  @NotEmpty
  private String passwordRepeated = "";
  @NotNull
  private Role role = Role.USER;
}
```
#### Service
```java
//Service层接口
public interface UserService {
  Optional<User> getUserById(long id);
  Optional<User> getUserByEmail(String email);
  Collection<User> getAllUsers();
  User create(UserCreateForm form);
}
//Service层实现
@Service
public class UserServiceImpl implements UserService {
  private final UserRepository userRepository;
  @Autowired
  public UserServiceImpl(UserRepository userRepository) {
    this.userRepository = userRepository;
  }
  @Override
  public Optional<User> getUserById(long id) {
    return Optional.ofNullable(userRepository.findOne(id));
  }
  @Override
  public Optional<User> getUserByEmail(String email) {
    return  userRepository.findOneByEmail(email);
  }
  @Override
  public Collection<User> getAllUsers() {
    return userRepository.findAll(new Sort("email"));
  }
  @Override
  public User create(UserCreateForm form) {
    User user = new User();
    user.setEmail(form.getEmail());
    user.setPasswordHash(new BCryptPasswordEncoder().encode(form.getPassword()));
    user.setRole(form.getRole());
    return userRepository.save(user);
  }
}
```
#### Dao
```java
public interface UserRepository extends JpaRepository<User,Long> {
  Optional<User> findOneByEmail(String email);
}
```
#### Controller
```java
//home
@Controller
public class HomeController {
  @RequestMapping("/")
  public String getHomePage() {
    return "home";
  }
}
//Users
@Controller
public class UsersController {
  private final UserService userService;
  @Autowired
  public UsersController(UserService userService) {
    this.userService  = userService;
  }
  @RequestMapping("/users")
  public ModelAndView getUsersPage() {
    return new ModelAndView("users", "users", userService.getAllUsers());
  }
}
//User
@Controller
public class UserController {
  private final UserService userService;
  private final UserCreateFormValidator userCreateFormValidator;
  @Autowired
  public UserController(UserService userService, UserCreateFormValidator userCreateFormValidator) {
    this.userService = userService;
    this.userCreateFormValidator = userCreateFormValidator;
  }
  @InitBinder("form")
  public void initBinder(WebDataBinder binder) {
    binder.addValidators(userCreateFormValidator);
  }
  @RequestMapping("/user/{id}")
  public ModelAndView getUserPage(@PathVariable Long id) {
    return new ModelAndView("user", "user", userService.getUserById(id).orElseThrow(
      () -> new NoSuchElementException(String.format("User=%s not found", id))));
  }
  @RequestMapping(value = "/user/create", method = RequestMethod.GET)
  public ModelAndView getUserCreatePage() {
    return new ModelAndView("user_create", "form", new UserCreateForm());
  }
  @RequestMapping(value = "/user/create", method = RequestMethod.POST)
  public String handleUserCreateForm(@Valid @ModelAttribute("form") UserCreateForm form,
      BindingResult bindingResult) {
    if(bindingResult.hasErrors()) {
      return "user_create";
    }
    try {
      userService.create(form);
    } catch (DataIntegrityViolationException e) {
      bindingResult.reject("email.exists", "Email already exists");
      return "user_create";
    }
    return "redirect:/users";
  }
}
//登录
@Controller
public class LoginController {
  @RequestMapping(value = "/login", method = RequestMethod.GET)
  public ModelAndView getLoginPage(@RequestParam Optional<String> error) {
    return new ModelAndView("login", "error", error);
  }
}
```
#### VO
```java
@Component
public class UserCreateFormValidator implements Validator {
  private final UserService userService;
  @Autowired
  public UserCreateFormValidator(UserService userService) {
    this.userService = userService;
  }
  @Override
  public boolean supports(Class<?> clazz) {
    return clazz.equals(UserCreateForm.class);
  }
  @Override
  public void validate(Object target, Errors errors) {
    UserCreateForm form = (UserCreateForm) target;
    validatePasswords(errors, form);
    validateEmail(errors, form);
  }
  private void validatePasswords(Errors errors, UserCreateForm form) {
    if(!form.getPassword().equals(form.getPasswordRepeated())) {
      errors.reject("password.no_match", "Passwords do not match");
    }
  }
  private void validateEmail(Errors errors, UserCreateForm form) {
    if(userService.getUserByEmail(form.getEmail()).isPresent()) {
      errors.reject("email.exists", "User with this email already exists");
    }
  }
}
```
#### Html
```html
<form role="form" action="/login" method="post">
  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
  <div>
    <label for="email">Email address</label>
    <input type="email" name="email"  id="email" required autofocus>
  </div>
  <div>
    <label for="password">Password</label>
    <input type="password" name="password" id="password" required>
  </div>
  <div>
    <label for="remember-me">Remember me</label>
    <input type="checkbox" name="remember-me" id="remember-me">
  </div>
  <button type="submit">Sign in</button>
</form>
<#if error.isPresent()>
  <p>The email or password you have entered is invalid, try again.</p>
</#if>
```
#### 配置类
```java
@Configuration
@Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
class SecurityConfig extends WebSecurityConfigurerAdapter {
  @Autowired
  private UserDetailsService userDetailsService;
  //授权？
  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
      .formLogin()
      .loginPage("/login")
      .failureUrl("/login?error")
      .usernameParameter("email")
      .permitAll()
      .and()
      .logout()
      .logoutUrl("/logout")
      .logoutSuccessUrl("/")
      .permitAll();
  }
  //认证？
  @Override
  public void configure(AuthenticationManagerBuilder auth) throws Exception {
    auth.userDetailsService(userDetailsService).passwordEncoder(new BCryptPasswordEncoder());
  }
}
```

### Spring Security的配置说明
我们先从上面的配置类开始。
#### ＠Order注解
＠Order注解主要用来控制Bean的加载顺序。上例中，配置成`@Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)`
是为了在Spring Boot **提供基本身份认证与访问控制前** 加载。设置了它，重写或自定义访问规则就在这里。

另一个授权的示例：
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
  http.authorizeRequests()
    .formLogin()
    .loginPage("/login")
    .failureUrl("/login?error")
    .usernameParameter("email")
    .permitAll()
    .and()
    .logout()
    .logoutUrl("/logout")
    .deleteCookies("remember-me")
    .logoutSuccessUrl("/")
    .permitAll()
    .and()
    .rememberMe();
}
```
