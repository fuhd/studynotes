CORS
===================================

### 什么是CORS？
CORS就是 **跨域资源共享** （Cross-Origin Resource Sharing）。

### CORS与JSONP区别
1. `JSONP`只能实现 **GET** 请求，而`CORS`支持 **所有类型的HTTP请求** 。
2. 使用`CORS`，开发者可以使用普通的`XMLHttpRequest`发起请求和获得数据，比起`JSONP`有更好的错误处理。
3. `JSONP`主要被老的浏览器支持，它们往往不支持`CORS`。而绝大多数现代浏览器都已经支持了CORS。

### 利用CORS实现跨域请求
跨域请求一直是网页编程中的一个难题。在过去，绝大多数人都倾向于使用JSONP来解决这一问题。不过现在，
我们可以考虑一下 **W3C** 中一项新的特性——CORS（Cross-Origin Resource Sharing）了。
#### 客户端
##### 创建XmlHttpRequest对象
对于CORS，Chrome、FireFox以及Safari，需要使用 **XmlHttpRequest2** 对象；而对于IE，则需要使用 **XDomainRequest**；
Opera目前还不支持这一特性，但很快就会支持（4年过去了，已经2015年了，应该支持了）。
因此，在对象的创建上，我们不得不首先针对不同的浏览器而进行一下预处理：
```javascript
function createCORSRequest(method,url){
  var xhr = new XMLHttpRequest();
  if("withCredentials" in xhr){
    //"withCredentials"属性是XMLHTTPRequest2中独有的
    xhr.open(method,url,true);
  }else if(typeof XDomainRequest != "undefined"){
    //检测是否XDomainRequest可用
    xhr = new XDomainRequest();
    xhr.open(method,url);
  }else{
    //看起来CORS根本不被支持
    xhr = null;
  }
  return xhr;
}
var xhr = createCORSRequest('GET',url);
if(!xhr){
  throw new Error('CORS not supported');
}
```
##### 事件处理
原先的`XmlHttpRequest`对象仅仅只有一个事件——`onreadystatechange`，用以通知所有的事件。而现在，
我们除了这个事件之外又多了很多新的：

事件|说明
---|------
onloadstart~|当请求发生时触发
onprogress|读取及发送数据时触发
onabort~|当请求被中止时触发，如使用abort()方法
onerror|当请求失败时触发
onload|当请求成功时触发
ontimeout|当调用者设定的超时时间已过而仍未成功时触发
onloadend~|请求结束时触发（无论成功与否）

注：带 **～号** 的表示IE的XDomainRequest仍不支持。



























































































































### CORS使用
假设`http://www.test1.com`是请求方，`http://www.test2.com`为被请求方。一般情况下，
如果我们直接使用`AJAX`来请求将会失败，浏览器也会返回 **源不匹配** 的错误，**跨域** 也就以此由来。
利用 **CORS**，`http://www.test2.com`只需添加一个或多个 **response header**，就可以允许来自`http://www.test1.com`的请求。
#### 简单跨域
要在servlet的 **doGet** 或者 **doPost** 方法里增加 **response header参数**。
示例，设置 **星号（＊）** 表示允许任何域向我们的服务端提交请求：
```java
response.addHeader("Access-Control-Allow-Origin", "*");  
```
也可以设置 **指定的域名**，如域名：`http://www.test1.com`，那么就允许来自这个域名的请求：
```java
response.addHeader("Access-Control-Allow-Origin", "http://www.test1.com");
```
#### 复杂跨域
浏览器会先发起一个验证的网络连接到servlet的 **doOptions** 方法（预先请求），在方法里设置：
```java
//允许跨域访问的域，可以是一个域的列表，也可以是通配符"*"
response.addHeader("Access-Control-Allow-Origin","http://www.test1.com");
//允许使用的请求方法，以逗号隔开
response.addHeader("Access-Control-Allow-Methods","GET,POST,OPTIONS");
//允许自定义的头部，以逗号隔开，大小写不敏感
response.addHeader("Access-Control-Allow-Headers","Content-type,hello");
/*缓存此次请求的秒数。在这个时间范围内，所有同类型的请求都将不再发送预检请求而是直接使用此次返回的头作为判断依据，
非常有用，大幅优化请求次数*/
response.addHeader("Access-Control-Max-Age","50");
```
#### 传参
如果使用POST传参，在Ajax调用上要添加：
```javascript
xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
```
如果使用GET传参，请求参数直接添加到URL里。
#### 一个完整的处理CORS的Servlet
```java
public class TestOut extends HttpServlet{
  @Override
  protected void doGet(HttpServletRequest req,HttpServletResponse resp)
      throws ServletException,IOException{
    resp.addHeader("Access-Control-Allow-Origin","http://zhucetest.duapp.com");
  }
  @Override
  protected void doPost(HttpServletRequest req,HttpServletResponse resp)
      throws ServletException,IOException{
    resp.addHeader("Access-Control-Allow-Origin","http://zhucetest.duapp.com");
  }
  @Override
  protected void doOptions(HttpServletRequest req,HttpServletResponse resp)
      throws ServletException,IOException{
    resp.addHeader("Access-Control-Allow-Origin","http://zhucetest.duapp.com");
    resp.addHeader("Access-Control-Allow-Methods","GET,POST,OPTIONS");
    resp.addHeader("Access-Control-Allow-Headers","Content-type,hello");
    resp.addHeader("Access-Control-Max-Age","50");
  }
}
```

### CORS安全性
CORS也是存在安全性问题的，需要配合其它技术！！
